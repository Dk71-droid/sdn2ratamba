<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Latihanku</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <!-- Poppins font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f0f4f8; /* Light blue-gray background */
        color: #334155; /* Slate-700 text */
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        overflow-x: hidden; /* Prevent horizontal scroll */
      }

      .container {
        max-width: 960px;
        margin: 0 auto;
        padding: 1.25rem;
        width: 100%;
      }

      /* Responsive adjustments for container */
      @media (max-width: 767px) {
        /* For mobile devices */
        .container {
          padding: 0.5rem; /* Further reduced padding on small screens */
        }
      }

      .card {
        background-color: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        padding: 1.5rem;
        margin-bottom: 1.2rem;
      }
      @media (max-width: 767px) {
        .card {
          padding: 0.8rem; /* Reduced padding for mobile cards */
        }
      }
      .card-header {
        font-size: 1.25rem;
        font-weight: 600;
        color: #06b6d4; /* Cyan-700 */
        margin-bottom: 1rem;
      }

      /* Global Message Component Styles */
      #globalMessage {
        position: fixed;
        top: 0.75rem;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10000;
        padding: 0.6rem 0.8rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        max-width: 90%;
        width: 260px;
        text-align: left;
        font-size: 0.8rem;
      }
      #globalMessage.hidden {
        display: none;
      }
      #globalMessage.bg-green-100 {
        background-color: #d1fae5;
        border-color: #34d399;
        color: #065f46;
      }
      #globalMessage.bg-red-100 {
        background-color: #fee2e2;
        border-color: #ef4444;
        color: #991b1b;
      }
      #globalMessage.bg-blue-100 {
        background-color: #dbeafe;
        border-color: #3b82f6;
        color: #1e40af;
      }
      #globalMessage .font-bold {
        font-weight: 700;
        font-size: 0.85rem;
      }
      #globalMessage #messageCloseBtn {
        cursor: pointer;
        font-size: 1rem;
      }

      /* Page Transition Styles */
      #appView {
        opacity: 0; /* Start invisible */
        transition: opacity 0.5s ease-in-out; /* Smooth fade-in */
        width: 100%; /* Ensure it takes full width */
        display: flex; /* Make it a flex container */
        flex-direction: column; /* Stack its children vertically */
        flex-grow: 1; /* Allow it to take up available vertical space */
      }
      #appView.hidden {
        display: none; /* Truly hidden before fade-in starts */
      }
      #appView.fade-in {
        opacity: 1;
      }
      #appView.fade-out {
        opacity: 0;
        transition: opacity 0.3s ease-in-out; /* Faster fade-out */
      }

      /* New: Main view sections (login and app) */
      .full-screen-view {
        width: 100%;
        flex-grow: 1; /* Allow it to take up available vertical space */
        display: flex; /* Make it a flex container */
        flex-direction: column; /* Stack its children vertically */
        overflow-y: auto; /* Allow scrolling if content overflows */
        -webkit-overflow-scrolling: touch;
        background-color: #f0f4f8; /* Match body background */
      }

      /* Tab content sections */
      .tab-content-section {
        display: none; /* Hidden by default */
      }
      .tab-content-section.active {
        display: block; /* Only active section is shown */
      }

      /* AI Exercise specific styles */
      .ai-question-item {
        background-color: #f8fafc;
        padding: 0.7rem; /* Further reduced padding */
        border-radius: 0.5rem;
        margin-bottom: 0.7rem; /* Further reduced margin */
        border: 1px solid #e2e8f0;
        font-size: 0.8rem; /* Even smaller font for question items */
      }
      .ai-question-item p strong {
        color: #06b6d4;
      }
      .ai-question-item small {
        color: #64748b;
        font-style: italic;
        font-size: 0.7rem; /* Even smaller font for small text */
      }
      .ai-reading-text {
        background-color: #f0f9ff;
        padding: 0.7rem; /* Further reduced padding */
        border-left: 4px solid #06b6d4;
        border-radius: 0.5rem;
        margin-bottom: 1rem; /* Further reduced margin */
        line-height: 1.4; /* Further reduced line height */
        text-align: justify;
        font-size: 0.8rem; /* Even smaller font for reading text */
      }
      @media (max-width: 767px) {
        .ai-reading-text {
          font-size: 0.75rem; /* Smallest font on mobile */
          padding: 0.5rem; /* Smallest padding on mobile */
        }
      }
      .loading-spinner {
        display: inline-block;
        width: 18px; /* Slightly smaller spinner */
        height: 18px; /* Slightly smaller spinner */
        border: 2px solid rgba(255, 255, 255, 0.3); /* Thinner border */
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        -webkit-animation: spin 1s ease-in-out infinite;
        margin-left: 0.4rem; /* Reduced margin */
        vertical-align: middle;
      }

      @keyframes spin {
        to {
          -webkit-transform: rotate(360deg);
        }
      }
      @-webkit-keyframes spin {
        to {
          -webkit-transform: rotate(360deg);
        }
      }

      /* Table styles */
      .data-table {
        width: 100%;
        border-collapse: collapse;
      }
      .data-table th,
      .data-table td {
        padding: 0.5rem 0.6rem; /* Further reduced padding */
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
        font-size: 0.75rem; /* Even smaller font for table content */
      }
      .data-table th {
        background-color: #f8fafc;
        font-weight: 600;
        color: #475569;
        text-transform: uppercase;
        font-size: 0.7rem; /* Even smaller font for table headers */
      }
      @media (min-width: 768px) {
        .data-table td {
          font-size: 0.85rem; /* Slightly larger on desktop, but still smaller than before */
        }
      }
      .data-table tbody tr:hover {
        background-color: #f0f4f8;
      }
      .overflow-x-auto {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .data-table .actions-col {
        min-width: 80px; /* Further smaller min-width */
      }
      .data-table .actions-col button {
        padding: 0.15rem 0.3rem; /* Further reduced padding */
        font-size: 0.65rem; /* Even smaller font for action buttons */
      }

      /* Fixed Bottom Navigation */
      .bottom-nav {
        position: fixed; /* Keep it fixed */
        bottom: 0;
        left: 0;
        right: 0;
        background-color: white;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-around;
        padding: 0.3rem 0; /* Further reduced padding */
        z-index: 50;
      }
      .bottom-nav button {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.3rem 0.15rem; /* Further reduced padding */
        color: #64748b; /* Slate-600 */
        font-size: 0.6rem; /* Even smaller font for nav text */
        font-weight: 500;
        transition: color 0.2s ease;
        border-radius: 0.5rem;
      }
      .bottom-nav button.active {
        color: #06b6d4; /* Cyan-500 */
        font-weight: 600;
      }
      .bottom-nav button i {
        font-size: 1rem; /* Even smaller font for icons */
        margin-bottom: 0.1rem; /* Further reduced margin */
      }
      .bottom-nav button:hover {
        color: #06b6d4;
      }

      /* Portal Title (h1) adjustments */
      #portalTitle {
        font-size: 1.8rem; /* Default for desktop */
        text-align: right; /* Align to the right */
        flex-grow: 1; /* Allow it to take available space */
      }
      @media (max-width: 767px) {
        #portalTitle {
          font-size: 0.875rem; /* Significantly smaller for mobile (14px) */
        }
      }

      /* Dark Mode Styles */
      body.dark-mode {
        background-color: #1a202c; /* Dark background */
        color: #e2e8f0; /* Light text */
      }
      body.dark-mode .card {
        background-color: #2d3748; /* Darker card background */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      body.dark-mode .card-header {
        color: #4fd1c5; /* Teal-400 for headers */
      }
      body.dark-mode input,
      body.dark-mode textarea {
        background-color: #4a5568;
        border-color: #64748b;
        color: #e2e8f0;
      }
      body.dark-mode input::placeholder,
      body.dark-mode textarea::placeholder {
        color: #a0aec0;
      }
      body.dark-mode .bottom-nav {
        background-color: #2d3748;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
      }
      body.dark-mode .bottom-nav button {
        color: #cbd5e0;
      }
      body.dark-mode .bottom-nav button.active {
        color: #4fd1c5;
      }
      body.dark-mode .ai-question-item {
        background-color: #2d3748;
        border-color: #4a5568;
      }
      body.dark-mode .ai-question-item p strong {
        color: #4fd1c5;
      }
      body.dark-mode .ai-question-item small {
        color: #a0aec0;
      }
      body.dark-mode .ai-reading-text {
        background-color: #2d3748;
        border-left-color: #4fd1c5;
      }
      body.dark-mode .ai-reading-text h4 {
        color: #4fd1c5;
      }
      body.dark-mode .data-table th {
        background-color: #4a5568;
        color: #e2e8f0;
      }
      body.dark-mode .data-table tbody tr:hover {
        background-color: #4a5568;
      }
      body.dark-mode .modal-overlay .bg-white {
        background-color: #2d3748;
        color: #e2e8f0;
      }
      body.dark-mode .modal-overlay h3 {
        color: #4fd1c5;
      }
      body.dark-mode .modal-overlay .text-gray-700 {
        color: #e2e8f0;
      }
      body.dark-mode .modal-overlay .text-gray-500 {
        color: #a0aec0;
      }
      body.dark-mode #globalMessage.bg-blue-100 {
        background-color: #2c5282;
        border-color: #4299e1;
        color: #ebf8ff;
      }
      body.dark-mode #globalMessage.bg-green-100 {
        background-color: #2f855a;
        border-color: #48bb78;
        color: #ebf8ff;
      }
      body.dark-mode #globalMessage.bg-red-100 {
        background-color: #9b2c2c;
        border-color: #e53e3e;
        color: #fed7d7;
      }

      /* Reading Mode Styles */
      body.reading-mode {
        font-family: "Georgia", serif; /* Serif font for readability */
        line-height: 1.6; /* Further reduced line height */
        font-size: 1rem; /* Slightly smaller font size */
      }
      body.reading-mode .ai-reading-text,
      body.reading-mode .ai-question-item {
        font-size: 1rem; /* Adjust font size for content within reading mode */
      }
      body.reading-mode.dark-mode .ai-reading-text {
        background-color: #3e2723; /* Dark brown background for dark mode reading */
        border-left-color: #ffc107;
        color: #fff8e1;
      }
    </style>
  </head>
  <body>
    <!-- Global Message Component -->
    <div
      id="globalMessage"
      class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] p-4 rounded-md shadow-lg hidden max-w-sm w-full"
      role="alert"
    >
      <div class="flex justify-between items-center">
        <p id="messageTitle" class="font-bold"></p>
        <button id="messageCloseBtn" class="text-current text-lg font-bold">
          Ã—
        </button>
      </div>
      <p id="messageText"></p>
    </div>

    <!-- Main App View (Login view is removed from this file) -->
    <div id="appView" class="full-screen-view hidden">
      <div id="headerSection" class="container">
        <div class="flex justify-between items-center mb-6">
          <button
            id="backButton"
            class="text-slate-800 hover:text-cyan-600 transition duration-200 text-2xl"
          >
            <i class="fas fa-home"></i>
            <!-- Changed icon to home -->
          </button>
          <h1 class="font-bold text-slate-800" id="portalTitle">
            Aplikasi Latihanku Siswa
          </h1>
          <!-- Removed logout button from here -->
        </div>
      </div>

      <main class="container flex-grow pb-24">
        <!-- Added flex-grow and pb-24 for bottom nav space -->
        <!-- Dashboard View -->
        <div id="dashboardView" class="tab-content-section active">
          <!-- AI Motivation Card -->
          <div class="card mb-6">
            <h2 class="card-header">Saran & Motivasi AI untuk Anda</h2>
            <div id="aiMotivationContent" class="text-gray-700 text-sm">
              <!-- AI message or loading spinner will go here -->
              <div class="flex items-center justify-center py-4">
                <div class="loading-spinner"></div>
                <span class="ml-2">Memuat saran AI...</span>
              </div>
            </div>
          </div>
          <!-- Only one card for average score -->
          <div class="grid grid-cols-1 gap-4 mb-6" id="dashboardStatsContainer">
            <!-- Stats will be rendered here -->
          </div>
          <div class="card">
            <h2 class="card-header">Progres Latihan Saya</h2>
            <div class="relative h-64">
              <canvas id="studentPerformanceChart"></canvas>
            </div>
            <p class="text-xs text-gray-500 mt-4">
              Diagram ini menunjukkan progres nilai Anda untuk latihan Literasi
              dan Numerasi.
            </p>
          </div>
          <div class="card mt-6">
            <h2 class="card-header">Riwayat Latihan Terbaru</h2>
            <div id="recentActivitiesTableContainer" class="overflow-x-auto">
              <!-- Recent activities table will be rendered here -->
            </div>
          </div>
        </div>

        <!-- Latihan Harian View -->
        <div id="dailyExerciseView" class="tab-content-section">
          <div class="card">
            <h2 class="card-header">Latihan Harian AI</h2>
            <div id="dailyExerciseContent">
              <!-- Daily exercise content will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Riwayat Latihan View -->
        <div id="exerciseHistoryView" class="tab-content-section">
          <div class="card">
            <h2 class="card-header">Riwayat Latihan Saya</h2>
            <div id="exerciseHistoryTableContainer" class="overflow-x-auto">
              <!-- Exercise history table will be rendered here -->
            </div>
          </div>
        </div>

        <!-- Pengaturan View -->
        <div id="settingsView" class="tab-content-section">
          <div class="card">
            <h2 class="card-header">Pengaturan Tampilan</h2>
            <div class="flex items-center justify-between mb-4">
              <span>Mode Gelap:</span>
              <div class="flex space-x-2">
                <button
                  id="setLightMode"
                  class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl transition duration-200"
                >
                  Terang
                </button>
                <button
                  id="setDarkMode"
                  class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200"
                >
                  Gelap
                </button>
              </div>
            </div>
            <div class="flex items-center justify-between mb-4">
              <span>Mode Membaca:</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="toggleReadingMode"
                  class="sr-only peer"
                />
                <div
                  class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"
                ></div>
              </label>
            </div>
            <button
              id="resetSettings"
              class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-300 ease-in-out mb-4"
            >
              Reset Pengaturan
            </button>
            <!-- Moved logout button here -->
            <button
              id="logoutButton"
              class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-300 ease-in-out"
            >
              <i class="fas fa-sign-out-alt mr-2"></i> Keluar
            </button>
          </div>
        </div>
      </main>

      <!-- Fixed Bottom Navigation -->
      <nav class="bottom-nav" id="bottomNav">
        <button id="navDashboard" data-view="dashboard">
          <i class="fas fa-chart-pie"></i>
          <span>Dashboard</span>
        </button>
        <button id="navDailyExercise" data-view="dailyExercise">
          <i class="fas fa-book-open"></i>
          <span>Latihan</span>
        </button>
        <button id="navExerciseHistory" data-view="exerciseHistory">
          <i class="fas fa-history"></i>
          <span>Riwayat</span>
        </button>
        <button id="navSettings" data-view="settings">
          <i class="fas fa-cog"></i>
          <span>Pengaturan</span>
        </button>
      </nav>
    </div>

    <!-- Modal Container (for all modals) -->
    <div id="modal-container"></div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signInAnonymously,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        doc,
        getDoc,
        setDoc, // Import setDoc
        updateDoc,
        addDoc,
        onSnapshot,
        serverTimestamp,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

      // --- Firebase Configuration ---
      const firebaseConfig = {
        apiKey: "AIzaSyBWTYZH2OZuyq_mnbbxiap7iBg-17II55A",
        authDomain: "tabungansiswa-8bbd6.firebaseapp.com",
        projectId: "tabungansiswa-8bbd6",
        storageBucket: "tabungansiswa-8bbd6.firebasestorage.app",
        messagingSenderId: "1068130708793",
        appId: "1:1068130708793:web:d6afeed38a9d42dd034ce8",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- Global State Variables ---
      let studentData = null; // Will be populated from Firestore based on localStorage ID
      let studentMotivation = {
        message: null,
        lastGenerated: null,
        isGenerating: false,
      };
      let currentStudentView = "dashboard"; // 'dashboard', 'dailyExercise', 'exerciseHistory', 'settings'
      let dailyExercise = null;
      let studentExerciseHistory = [];
      let studentPerformanceChart = null;

      // State for Modals
      let showConfirmationModal = false;
      let confirmationMessage = "";
      let confirmationAction = null;
      let showAISuggestionsModal = false;
      let aiSuggestionsContent = "";
      let aiSuggestionsTitle = "";
      let showExerciseDetailsModal = false;
      let exerciseDetailsData = null;

      // PENTING: Kunci API Gemini diekspos di sini.
      // Ini adalah RISIKO KEAMANAN yang signifikan.
      // Siapa pun yang mengakses kode ini dapat melihat dan menyalahgunakan kunci Anda.
      // Untuk keamanan yang lebih baik, gunakan Firebase Cloud Functions atau server backend.
      const GEMINI_API_KEY = "AIzaSyBH0hk2aXOVQzB6bCAonrwWYDkqXJ-kn9w"; // GANTI DENGAN KUNCI API GEMINI ANDA YANG SEBENARNYA!
      const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

      // --- DOM Elements ---
      const appView = document.getElementById("appView");
      const portalTitle = document.getElementById("portalTitle");
      const bottomNav = document.getElementById("bottomNav");
      let modalContainer = document.getElementById("modal-container");

      // Global Message Component
      const globalMessage = document.getElementById("globalMessage");
      const messageTitle = document.getElementById("messageTitle");
      const messageText = document.getElementById("messageText");
      const messageCloseBtn = document.getElementById("messageCloseBtn");
      const backButton = document.getElementById("backButton"); // New back button

      // --- Helper Functions ---
      const showMessage = (type, text, titleOverride = null) => {
        globalMessage.classList.remove(
          "hidden",
          "bg-blue-100",
          "border-blue-500",
          "text-blue-700",
          "bg-green-100",
          "border-green-500",
          "text-green-700",
          "bg-red-100",
          "border-red-500",
          "text-red-700",
          "bg-gray-100",
          "border-gray-500",
          "text-gray-700"
        );

        let bgColor, borderColor, textColor, title;
        let duration = 3000;

        switch (type) {
          case "loading":
            bgColor = "bg-blue-100";
            borderColor = "border-blue-500";
            textColor = "text-blue-700";
            title = "Memuat...";
            break;
          case "success":
            bgColor = "bg-green-100";
            borderColor = "border-green-500";
            textColor = "text-green-700";
            title = "Berhasil!";
            break;
          case "error":
            bgColor = "bg-red-100";
            borderColor = "border-red-500";
            textColor = "text-red-700";
            title = "Terjadi Kesalahan!";
            duration = 5000;
            break;
          case "info":
            bgColor = "bg-blue-100";
            borderColor = "border-blue-500";
            textColor = "text-blue-700";
            title = "Informasi";
            break;
          default:
            bgColor = "bg-gray-100";
            borderColor = "border-gray-500";
            textColor = "text-gray-700";
            title = "";
        }

        messageTitle.innerText = titleOverride || title;
        globalMessage.classList.add(
          bgColor,
          `border-l-4`,
          borderColor,
          textColor
        );
        messageText.innerText = text;
        globalMessage.classList.remove("hidden");

        if (type !== "loading") {
          setTimeout(() => globalMessage.classList.add("hidden"), duration);
        }

        messageCloseBtn.onclick = () => globalMessage.classList.add("hidden");
      };

      function showConfirmModal(message, action) {
        confirmationMessage = message;
        confirmationAction = action;
        showConfirmationModal = true;
        renderModals();
        attachDynamicEventListeners();
      }

      // --- Theme Settings ---
      function applySavedSettings() {
        const theme = localStorage.getItem("studentTheme");
        if (theme === "dark") {
          document.body.classList.add("dark-mode");
        } else {
          document.body.classList.remove("dark-mode");
        }

        const readingMode = localStorage.getItem("studentReadingMode");
        const toggleReadingModeCheckbox =
          document.getElementById("toggleReadingMode");
        if (readingMode === "true") {
          document.body.classList.add("reading-mode");
          if (toggleReadingModeCheckbox)
            toggleReadingModeCheckbox.checked = true;
        } else {
          document.body.classList.remove("reading-mode");
          if (toggleReadingModeCheckbox)
            toggleReadingModeCheckbox.checked = false;
        }
      }

      function setLightMode() {
        localStorage.setItem("studentTheme", "light");
        applySavedSettings();
      }

      function setDarkMode() {
        localStorage.setItem("studentTheme", "dark");
        applySavedSettings();
      }

      function toggleReadingMode() {
        const isReadingMode = document.body.classList.toggle("reading-mode");
        localStorage.setItem(
          "studentReadingMode",
          isReadingMode ? "true" : "false"
        );
      }

      function resetSettings() {
        showConfirmModal(
          "Apakah Anda yakin ingin mereset semua pengaturan tampilan ke default?",
          () => {
            localStorage.removeItem("studentTheme");
            localStorage.removeItem("studentReadingMode");
            applySavedSettings();
            showMessage("success", "Pengaturan telah direset.");
          }
        );
      }

      // --- Firebase Auth State Listener ---
      onAuthStateChanged(auth, async (user) => {
        const studentAppIdFromLocalStorage = localStorage.getItem(
          "currentStudentAppId"
        );

        if (user) {
          // Firebase user exists. Now, verify our custom student ID in localStorage.
          if (studentAppIdFromLocalStorage) {
            const studentDocRef = doc(
              db,
              "users",
              studentAppIdFromLocalStorage
            );
            try {
              const docSnap = await getDoc(studentDocRef);
              if (docSnap.exists() && docSnap.data().role === "student") {
                // Valid session: Firebase user exists AND custom student ID is valid
                studentData = { id: docSnap.id, ...docSnap.data() };
                setupFirestoreListeners(user.uid, studentData.id);
                renderMainContent();
                portalTitle.innerText = `Halo, ${studentData.name}!`;
                appView.classList.remove("hidden"); // Make it visible
                appView.classList.add("fade-in"); // Trigger fade-in
              } else {
                // Firebase user exists, but custom student ID is invalid or role mismatch
                console.warn(
                  "Invalid student ID in localStorage or role mismatch. Forcing Firebase logout and redirecting to login."
                );
                localStorage.removeItem("currentStudentAppId"); // Clear invalid data
                await signOut(auth); // Force Firebase logout
                window.location.href = "login.html"; // Redirect to login
              }
            } catch (error) {
              console.error(
                "Error fetching student data from Firestore:",
                error
              );
              localStorage.removeItem("currentStudentAppId");
              await signOut(auth);
              window.location.href = "login.html";
            }
          } else {
            // Firebase user exists, but no custom student ID in localStorage.
            // This means the Firebase session is active but our custom user isn't linked.
            console.warn(
              "Firebase user active but no student ID in localStorage. Forcing Firebase logout and redirecting to login."
            );
            await signOut(auth); // Force Firebase logout
            window.location.href = "login.html"; // Redirect to login
          }
        } else {
          // No Firebase user. Ensure localStorage is clear and redirect to login.
          console.warn("No Firebase user active. Redirecting to login.");
          localStorage.removeItem("currentStudentAppId");
          window.location.href = "login.html";
        }
      });

      // --- Firestore Listeners ---
      let unsubscribeStudentProfile;
      let unsubscribeDailyExercise;
      let unsubscribeStudentExerciseHistory;
      let unsubscribeStudentMotivation;

      function setupFirestoreListeners(firebaseAuthUid, studentAppId) {
        // Unsubscribe from previous listeners to prevent memory leaks and duplicate updates
        if (unsubscribeStudentProfile) unsubscribeStudentProfile();
        if (unsubscribeDailyExercise) unsubscribeDailyExercise();
        if (unsubscribeStudentExerciseHistory)
          unsubscribeStudentExerciseHistory();
        if (unsubscribeStudentMotivation) unsubscribeStudentMotivation();

        // Listener for student's own profile (users collection)
        if (studentAppId) {
          const studentDocRef = doc(db, "users", studentAppId);
          unsubscribeStudentProfile = onSnapshot(
            studentDocRef,
            (docSnap) => {
              if (docSnap.exists() && docSnap.data().role === "student") {
                studentData = { id: docSnap.id, ...docSnap.data() };
                if (studentData.isGeneratingMotivation === undefined) {
                  studentData.isGeneratingMotivation = false;
                }
                if (
                  currentStudentView === "dashboard" ||
                  currentStudentView === "settings"
                ) {
                  renderDashboardView();
                  renderSettingsView();
                }
                portalTitle.innerText = `Halo, ${studentData.name}!`;
              } else {
                console.log(
                  "No student data found for current user or role is not student, or ID mismatch! Forcing logout."
                );
                signOut(auth);
              }
            },
            (error) => {
              console.error("Error fetching student data:", error);
              showMessage("error", "Gagal memuat data profil siswa.");
            }
          );
        } else {
          console.warn(
            "setupFirestoreListeners called for student profile without valid studentAppId."
          );
        }

        // Listener for student's motivation messages (uses Firebase Auth UID as document ID)
        if (firebaseAuthUid) {
          const studentMotivationDocRef = doc(
            db,
            "student_motivation_messages",
            firebaseAuthUid
          );
          unsubscribeStudentMotivation = onSnapshot(
            studentMotivationDocRef,
            (docSnap) => {
              if (docSnap.exists()) {
                studentMotivation.message = docSnap.data().message;
                studentMotivation.lastGenerated = docSnap
                  .data()
                  .lastGenerated?.toDate();
              } else {
                studentMotivation.message = null;
                studentMotivation.lastGenerated = null;
              }
              if (currentStudentView === "dashboard") {
                renderDashboardView();
              }
            },
            (error) => {
              console.error(
                "Error fetching student motivation message:",
                error
              );
              showMessage("error", "Gagal memuat pesan motivasi AI.");
            }
          );
        } else {
          console.warn(
            "setupFirestoreListeners called for motivation without valid firebaseAuthUid."
          );
        }

        // Listener for current day's AI exercise (does not depend on student ID)
        const todayDate = new Date().toISOString().slice(0, 10);
        const dailyExerciseDocRef = doc(db, "daily_ai_exercises", todayDate);
        unsubscribeDailyExercise = onSnapshot(
          dailyExerciseDocRef,
          (docSnap) => {
            if (docSnap.exists()) {
              dailyExercise = { id: docSnap.id, ...docSnap.data() };
            } else {
              dailyExercise = null;
            }
            if (currentStudentView === "dailyExercise") {
              renderDailyExerciseView();
            }
          },
          (error) => {
            console.error("Error fetching daily exercise:", error);
            showMessage("error", "Gagal memuat soal latihan harian.");
          }
        );

        // Listener for student's exercise history (uses studentAppId)
        if (studentAppId) {
          const studentHistoryQuery = query(
            collection(db, "student_exercise_history"),
            where("studentId", "==", studentAppId)
          );
          unsubscribeStudentExerciseHistory = onSnapshot(
            studentHistoryQuery,
            (snapshot) => {
              studentExerciseHistory = snapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
              studentExerciseHistory.sort((a, b) => {
                const timestampA = a.timestamp
                  ? a.timestamp.toDate
                    ? a.timestamp.toDate()
                    : new Date(a.timestamp)
                  : new Date(0);
                const timestampB = b.timestamp
                  ? b.timestamp.toDate
                    ? b.timestamp.toDate()
                    : new Date(b.timestamp)
                  : new Date(0);
                return timestampB - timestampA;
              });
              if (
                currentStudentView === "dashboard" ||
                currentStudentView === "exerciseHistory"
              ) {
                renderDashboardView();
                renderExerciseHistoryView();
              }
            },
            (error) => {
              console.error("Error fetching student exercise history:", error);
              showMessage("error", "Gagal memuat riwayat latihan Anda.");
            }
          );
        } else {
          console.warn(
            "setupFirestoreListeners called for exercise history without valid studentAppId."
          );
        }
      }

      async function handleLogout() {
        showConfirmModal("Apakah Anda yakin ingin keluar?", async () => {
          showMessage("loading", "Sedang logout...");
          try {
            await signOut(auth);
            studentData = null;
            localStorage.removeItem("currentStudentAppId"); // Clear custom student ID from localStorage
            studentMotivation = {
              message: null,
              lastGenerated: null,
              isGenerating: false,
            };
            dailyExercise = null;
            studentExerciseHistory = [];
            currentStudentView = "dashboard";
            if (studentPerformanceChart) {
              studentPerformanceChart.destroy();
              studentPerformanceChart = null;
            }

            // Clear modal states
            showConfirmationModal = false;
            confirmationMessage = "";
            confirmationAction = null;
            showAISuggestionsModal = false;
            aiSuggestionsContent = "";
            aiSuggestionsTitle = "";
            showExerciseDetailsModal = false;
            exerciseDetailsData = null;

            // Unsubscribe all listeners
            if (unsubscribeStudentProfile) unsubscribeStudentProfile();
            if (unsubscribeDailyExercise) unsubscribeDailyExercise();
            if (unsubscribeStudentExerciseHistory)
              unsubscribeStudentExerciseHistory();
            if (unsubscribeStudentMotivation) unsubscribeStudentMotivation();

            showMessage("success", "Berhasil logout.");
            appView.classList.add("fade-out"); // Apply fade-out before redirect
            setTimeout(() => {
              window.location.href = "portalsiswa.html"; // Redirect to login portal
            }, 300); // Match CSS transition duration
          } catch (error) {
            console.error("Logout error:", error);
            showMessage("error", "Gagal logout: " + error.message);
          }
        });
      }

      // --- Main Content Renderer ---
      function renderMainContent() {
        // In latihankuv2.html, we assume the user is already authenticated or will be redirected.
        // So, we directly show the appView and its content.
        bottomNav.style.display = "flex"; // Ensure bottom nav is visible

        // Hide all internal tab content sections within appView first
        document
          .querySelectorAll("#appView .tab-content-section")
          .forEach((section) => {
            section.classList.remove("active");
          });

        // Show the current active internal tab content section
        const activeViewElement = document.getElementById(
          `${currentStudentView}View`
        );
        if (activeViewElement) {
          activeViewElement.classList.add("active");
        }

        // Set active class for bottom navigation buttons
        document.querySelectorAll(".bottom-nav button").forEach((button) => {
          if (button.dataset.view === currentStudentView) {
            button.classList.add("active");
          } else {
            button.classList.remove("active");
          }
        });

        // Call specific render function for the active view
        switch (currentStudentView) {
          case "dashboard":
            renderDashboardView();
            break;
          case "dailyExercise":
            renderDailyExerciseView();
            break;
          case "exerciseHistory":
            renderExerciseHistoryView();
            break;
          case "settings":
            renderSettingsView();
            break;
        }
        renderModals();
        attachDynamicEventListeners();
      }

      // --- Sub-renderers for each view ---
      function renderDashboardView() {
        const dashboardViewElement = document.getElementById("dashboardView");
        if (!dashboardViewElement) return;

        const totalLiterasiScores = studentExerciseHistory
          .filter((h) => h.exerciseType === "Literasi")
          .reduce((sum, h) => sum + (h.score || 0), 0);
        const totalLiterasiCount = studentExerciseHistory.filter(
          (h) => h.exerciseType === "Literasi"
        ).length;

        const totalNumerasiScores = studentExerciseHistory
          .filter((h) => h.exerciseType === "Numerasi")
          .reduce((sum, h) => sum + (h.score || 0), 0);
        const totalNumerasiCount = studentExerciseHistory.filter(
          (h) => h.exerciseType === "Numerasi"
        ).length;

        const overallAverageScore = (
          (totalLiterasiScores + totalNumerasiScores) /
          (totalLiterasiCount + totalNumerasiCount || 1)
        ).toFixed(0);

        const dashboardStatsHtml = `
            <div class="card bg-gradient-to-br from-cyan-500 to-cyan-600 text-white">
                <p class="text-sm opacity-90">Rata-rata Nilai Keseluruhan</p>
                <p class="text-3xl font-bold mt-2">${overallAverageScore}</p>
            </div>
        `;
        document.getElementById("dashboardStatsContainer").innerHTML =
          dashboardStatsHtml;

        const recentActivities = studentExerciseHistory.slice(0, 5);
        const recentActivitiesTableHtml = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Jenis Latihan</th>
                        <th>Nilai</th>
                        <th class="actions-col">Saran AI</th>
                    </tr>
                </thead>
                <tbody>
                    ${recentActivities
                      .map(
                        (activity) => `
                            <tr>
                                <td>${activity.exerciseDate}</td>
                                <td>${activity.exerciseType}</td>
                                <td>${
                                  activity.score !== undefined
                                    ? activity.score
                                    : "N/A"
                                }</td>
                                <td class="actions-col">
                                    <button class="text-blue-500 hover:text-blue-700 text-sm view-ai-suggestions-btn" data-history-id="${
                                      activity.id
                                    }">
                                        <i class="fas fa-comment"></i> Lihat Saran
                                    </button>
                                </td>
                            </tr>
                        `
                      )
                      .join("")}
                    ${
                      recentActivities.length === 0
                        ? `<tr><td colspan="4" class="text-center text-gray-500">Belum ada riwayat latihan.</td></tr>`
                        : ""
                    }
                </tbody>
            </table>
        `;
        document.getElementById("recentActivitiesTableContainer").innerHTML =
          recentActivitiesTableHtml;

        renderStudentPerformanceChart();

        const aiMotivationContentDiv = document.getElementById(
          "aiMotivationContent"
        );
        if (!studentData) {
          aiMotivationContentDiv.innerHTML = `<p class="text-gray-600 text-sm">Silakan login untuk melihat saran AI.</p>`;
          return;
        }

        if (studentMotivation.message) {
          aiMotivationContentDiv.innerHTML = `<p class="text-gray-700 text-sm">${studentMotivation.message.replace(
            /\n/g,
            "<br>"
          )}</p>`;
        } else if (
          studentExerciseHistory.length > 0 &&
          !studentMotivation.isGenerating
        ) {
          studentMotivation.isGenerating = true;
          aiMotivationContentDiv.innerHTML = `
                <div class="flex items-center justify-center py-4">
                    <div class="loading-spinner"></div>
                    <span class="ml-2">Memuat saran AI...</span>
                </div>
            `;
          generateAndSaveMotivationMessage(
            overallAverageScore,
            totalLiterasiCount,
            totalNumerasiCount,
            studentExerciseHistory
          )
            .then(() => {})
            .catch((error) => {
              console.error("Error generating AI motivation message:", error);
              aiMotivationContentDiv.innerHTML = `<p class="text-red-500 text-sm">Gagal memuat saran AI: ${error.message}</p>`;
            })
            .finally(() => {
              studentMotivation.isGenerating = false;
            });
        } else if (studentExerciseHistory.length === 0) {
          aiMotivationContentDiv.innerHTML = `<p class="text-gray-600 text-sm">Selesaikan latihan pertama Anda untuk mendapatkan saran AI!</p>`;
        }

        document
          .querySelectorAll(".view-ai-suggestions-btn")
          .forEach((button) => {
            button.addEventListener("click", (e) => {
              const historyId = e.currentTarget.dataset.historyId;
              const historyItem = studentExerciseHistory.find(
                (item) => item.id === historyId
              );
              if (historyItem && historyItem.aiSuggestions) {
                showAISuggestionsModal = true;
                aiSuggestionsContent = historyItem.aiSuggestions;
                aiSuggestionsTitle = "Saran AI untuk Latihan Ini";
                renderModals();
                attachDynamicEventListeners();
              } else {
                showMessage(
                  "info",
                  "Tidak ada saran AI untuk latihan ini.",
                  "Info"
                );
              }
            });
          });
      }

      async function generateAndSaveMotivationMessage(
        overallAverageScore,
        totalLiterasiCount,
        totalNumerasiCount,
        history
      ) {
        const aiMotivationContentDiv = document.getElementById(
          "aiMotivationContent"
        );
        if (!aiMotivationContentDiv) return;

        const oneMonthAgo = new Date();
        oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

        const recentHistorySummary = history
          .filter((h) => {
            const timestamp = h.timestamp
              ? h.timestamp.toDate
                ? h.timestamp.toDate()
                : new Date(h.timestamp)
              : new Date(0);
            return timestamp >= oneMonthAgo;
          })
          .slice(0, 5)
          .map((h) => {
            return `Tanggal: ${h.exerciseDate}, Jenis: ${
              h.exerciseType
            }, Nilai: ${h.score}, Saran Sebelumnya: ${
              h.aiSuggestions || "Tidak ada saran."
            }`;
          })
          .join("\n");

        const prompt = `Sebagai seorang teman atau kakak yang peduli, tolong berikan pesan motivasi dan saran singkat (maksimal 3-4 kalimat) kepada siswa ini. Gunakan bahasa sehari-hari yang santai, akrab, dan dekat dengan siswa. Pesan harus berdasarkan riwayat latihan terakhirnya (dalam 1 bulan terakhir, maksimal 5 entri) dan rata-rata nilai. Fokus pada semangat untuk terus belajar dan berkembang, dan sebutkan secara umum area yang bisa ditingkatkan kalau ada pola dari saran-saran sebelumnya.

Riwayat Latihan Terakhir (dalam 1 bulan, maksimal 5 entri):
${recentHistorySummary || "Belum ada riwayat latihan dalam 1 bulan terakhir."}

Rata-rata Nilai Keseluruhan: ${overallAverageScore}
`;

        try {
          if (!GEMINI_API_KEY) {
            console.error("Error: GEMINI_API_KEY is not set.");
            aiMotivationContentDiv.innerHTML = `<p class="text-red-500 text-sm">Kesalahan: Kunci API Gemini tidak diatur.</p>`;
            return;
          }

          const payload = { contents: [{ parts: [{ text: prompt }] }] };
          const response = await fetch(GEMINI_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              `HTTP error! status: ${response.status} - ${
                errorData.error?.message || "Unknown error"
              }`
            );
          }

          const data = await response.json();
          const aiMessage = data.candidates[0].content.parts[0].text;

          if (auth.currentUser) {
            await setDoc(
              doc(db, "student_motivation_messages", auth.currentUser.uid),
              {
                message: aiMessage,
                lastGenerated: serverTimestamp(),
                studentAppId: studentData.id,
              },
              { merge: true }
            );
          } else {
            throw new Error(
              "No authenticated Firebase user found to save motivation message."
            );
          }
        } catch (error) {
          console.error(
            "Error generating and saving AI motivation message:",
            error
          );
          aiMotivationContentDiv.innerHTML = `<p class="text-red-500 text-sm">Gagal memuat saran AI: ${error.message}</p>`;
        } finally {
          studentMotivation.isGenerating = false;
        }
      }

      function renderDailyExerciseView() {
        const dailyExerciseViewElement =
          document.getElementById("dailyExerciseView");
        if (!dailyExerciseViewElement) return;

        const dailyExerciseContentDiv = document.getElementById(
          "dailyExerciseContent"
        );
        if (!dailyExerciseContentDiv) return;

        const todayDate = new Date().toISOString().slice(0, 10);
        const hasCompletedToday = studentExerciseHistory.some(
          (history) =>
            history.exerciseDate === todayDate &&
            history.studentId === studentData.id
        );

        if (dailyExercise) {
          if (hasCompletedToday) {
            const todayHistory = studentExerciseHistory.find(
              (history) =>
                history.exerciseDate === todayDate &&
                history.studentId === studentData.id
            );
            dailyExerciseContentDiv.innerHTML = `
              <h3 class="text-lg font-semibold text-slate-700 mb-3">Latihan Harian ${
                dailyExercise.type
              } (${dailyExercise.date})</h3>
              <p class="text-green-600 font-semibold mb-2">Anda telah menyelesaikan latihan ini untuk hari ini!</p>
              <p class="text-green-600 font-semibold mb-4">Nilai Anda: <strong>${
                todayHistory.score !== undefined ? todayHistory.score : "N/A"
              }</strong></p>
              ${
                dailyExercise.readingText
                  ? `
                <div class="ai-reading-text mt-4">
                    <h4 class="font-semibold text-cyan-700 mb-2">Bacaan:</h4>
                    <p>${dailyExercise.readingText.replace(/\n/g, "<br>")}</p>
                </div>`
                  : ""
              }
              <div>
                  <h4 class="font-semibold text-cyan-700 mb-2">Soal & Jawaban Anda:</h4>
                  ${todayHistory.answers
                    .map(
                      (ans, index) => `
                      <div class="ai-question-item">
                          <p><strong>Soal ${index + 1}:</strong> ${
                        ans.question
                      }</p>
                          <p class="text-gray-700">Jawaban Anda: ${
                            ans.answer
                          }</p>
                          <p class="text-gray-600 text-xs">Nilai: ${
                            ans.score !== undefined ? ans.score : "N/A"
                          }</p>
                          ${
                            ans.aiSuggestion
                              ? `<p class="text-gray-600 text-xs italic">Saran AI: ${ans.aiSuggestion}</p>`
                              : ""
                          }
                      </div>
                  `
                    )
                    .join("")}
              </div>
              ${
                todayHistory.aiSuggestions
                  ? `
                <div class="ai-reading-text mt-4">
                    <h4 class="font-semibold text-cyan-700 mb-2">Ringkasan Saran AI:</h4>
                    <p>${todayHistory.aiSuggestions.replace(/\n/g, "<br>")}</p>
                </div>
              `
                  : ""
              }
              <p class="text-sm text-gray-500 mt-4">Silakan kembali besok untuk latihan baru!</p>
            `;
          } else {
            const exerciseHtml = `
              <h3 class="text-lg font-semibold text-slate-700 mb-3">Soal Latihan ${
                dailyExercise.type
              } (${dailyExercise.date})</h3>
              ${
                dailyExercise.readingText
                  ? `<div class="ai-reading-text mb-4"><h4 class="font-semibold text-cyan-700 mb-2">Bacaan:</h4><p>${dailyExercise.readingText.replace(
                      /\n/g,
                      "<br>"
                    )}</p></div>`
                  : ""
              }
              <form id="exerciseForm" class="space-y-4">
                ${dailyExercise.questions
                  .map(
                    (q, index) => `
                  <div class="ai-question-item">
                    <p><strong>Soal ${index + 1}:</strong> ${
                      q.question
                    } <small>${
                      q.minWords ? `(Min. ${q.minWords} kata)` : ""
                    }</small></p>
                    <textarea id="answer${index}" class="w-full p-2 border border-gray-300 rounded-md mt-2 focus:ring-cyan-500 focus:border-cyan-500" rows="3" placeholder="Tulis jawaban Anda di sini..." required></textarea>
                  </div>
                `
                  )
                  .join("")}
                <button type="submit" id="submitExerciseBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-300 ease-in-out">
                  Kirim Jawaban
                </button>
              </form>
            `;
            dailyExerciseContentDiv.innerHTML = exerciseHtml;

            document
              .getElementById("exerciseForm")
              ?.addEventListener("submit", handleSubmitExercise);
          }
        } else {
          dailyExerciseContentDiv.innerHTML = `
            <p class="text-gray-600">Belum ada latihan harian yang tersedia untuk hari ini.</p>
            <p class="text-sm text-gray-500 mt-2">Silakan hubungi guru Anda jika Anda merasa ini adalah kesalahan.</p>
          `;
        }
      }

      function renderExerciseHistoryView() {
        const exerciseHistoryViewElement = document.getElementById(
          "exerciseHistoryView"
        );
        if (!exerciseHistoryViewElement) return;

        const exerciseHistoryTableContainer = document.getElementById(
          "exerciseHistoryTableContainer"
        );
        if (!exerciseHistoryTableContainer) return;

        if (studentExerciseHistory.length > 0) {
          const tableHtml = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Tanggal</th>
                  <th>Jenis Latihan</th>
                  <th>Nilai</th>
                  <th class="actions-col">Aksi</th>
                </tr>
              </thead>
              <tbody>
                ${studentExerciseHistory
                  .map(
                    (history) => `
                  <tr>
                    <td>${history.exerciseDate}</td>
                    <td>${history.exerciseType}</td>
                    <td>${
                      history.score !== undefined ? history.score : "N/A"
                    }</td>
                    <td class="actions-col">
                      <button class="text-blue-500 hover:text-blue-700 text-sm view-exercise-details-btn" data-history-id="${
                        history.id
                      }">
                        <i class="fas fa-eye"></i> Lihat Detail
                      </button>
                    </td>
                  </tr>
                `
                  )
                  .join("")}
              </tbody>
            </table>
          `;
          exerciseHistoryTableContainer.innerHTML = tableHtml;

          document
            .querySelectorAll(".view-exercise-details-btn")
            .forEach((button) => {
              button.addEventListener("click", (e) => {
                const historyId = e.currentTarget.dataset.historyId;
                const historyItem = studentExerciseHistory.find(
                  (item) => item.id === historyId
                );
                if (historyItem) {
                  exerciseDetailsData = historyItem;
                  showExerciseDetailsModal = true;
                  renderModals();
                  attachDynamicEventListeners();
                }
              });
            });
        } else {
          exerciseHistoryTableContainer.innerHTML = `<p class="text-gray-600">Anda belum menyelesaikan latihan apa pun.</p>`;
        }
      }

      function renderSettingsView() {
        const settingsViewElement = document.getElementById("settingsView");
        if (!settingsViewElement) return;

        applySavedSettings();

        document
          .getElementById("setLightMode")
          ?.removeEventListener("click", setLightMode);
        document
          .getElementById("setLightMode")
          ?.addEventListener("click", setLightMode);

        document
          .getElementById("setDarkMode")
          ?.removeEventListener("click", setDarkMode);
        document
          .getElementById("setDarkMode")
          ?.addEventListener("click", setDarkMode);

        document
          .getElementById("toggleReadingMode")
          ?.removeEventListener("change", toggleReadingMode);
        document
          .getElementById("toggleReadingMode")
          ?.addEventListener("change", toggleReadingMode);

        document
          .getElementById("resetSettings")
          ?.removeEventListener("click", resetSettings);
        document
          .getElementById("resetSettings")
          ?.addEventListener("click", resetSettings);

        // Attach logout button listener (now in settings)
        document
          .getElementById("logoutButton")
          ?.removeEventListener("click", handleLogout);
        document
          .getElementById("logoutButton")
          ?.addEventListener("click", handleLogout);
      }

      // --- Attach Event Listeners for Dynamically Rendered Content ---
      function attachDynamicEventListeners() {
        document.querySelectorAll(".bottom-nav button").forEach((button) => {
          button.removeEventListener("click", handleNavButtonClick);
          button.addEventListener("click", handleNavButtonClick);
        });

        // Logout button listener is now handled in renderSettingsView
        // document.getElementById("logoutButton")?.removeEventListener("click", handleLogout);
        // document.getElementById("logoutButton")?.addEventListener("click", handleLogout);

        // New: Back button listener
        backButton?.removeEventListener("click", handleBackButtonClick);
        backButton?.addEventListener("click", handleBackButtonClick);

        if (showConfirmationModal) {
          document
            .getElementById("cancelConfirm")
            ?.removeEventListener("click", handleCancelConfirm);
          document
            .getElementById("cancelConfirm")
            ?.addEventListener("click", handleCancelConfirm);
          document
            .getElementById("executeConfirm")
            ?.removeEventListener("click", handleExecuteConfirm);
          document
            .getElementById("executeConfirm")
            ?.addEventListener("click", handleExecuteConfirm);
        }
        if (showAISuggestionsModal) {
          document
            .getElementById("closeAISuggestionsModal")
            ?.removeEventListener("click", handleCloseAISuggestionsModal);
          document
            .getElementById("closeAISuggestionsModal")
            ?.addEventListener("click", handleCloseAISuggestionsModal);
        }
        if (showExerciseDetailsModal) {
          document
            .getElementById("closeExerciseDetailsModal")
            ?.removeEventListener("click", handleCloseExerciseDetailsModal);
          document
            .getElementById("closeExerciseDetailsModal")
            ?.addEventListener("click", handleCloseExerciseDetailsModal);
        }
      }

      function handleNavButtonClick(e) {
        currentStudentView = e.currentTarget.dataset.view;
        renderMainContent();
      }

      // New: Handle back button click
      function handleBackButtonClick() {
        appView.classList.add("fade-out"); // Apply fade-out effect
        setTimeout(() => {
          window.location.href = "portalsiswa.html"; // Navigate back to portalsiswa.html
        }, 300); // Match CSS transition duration
      }

      function handleCancelConfirm() {
        showConfirmationModal = false;
        confirmationMessage = "";
        confirmationAction = null;
        renderModals();
      }

      function handleExecuteConfirm() {
        if (confirmationAction) {
          confirmationAction();
        }
        showConfirmationModal = false;
        confirmationAction = null;
        renderModals();
      }

      function handleCloseAISuggestionsModal() {
        showAISuggestionsModal = false;
        aiSuggestionsContent = "";
        aiSuggestionsTitle = "";
        renderModals();
      }

      function handleCloseExerciseDetailsModal() {
        showExerciseDetailsModal = false;
        exerciseDetailsData = null;
        renderModals();
      }

      // --- Chart Rendering for Dashboard ---
      function renderStudentPerformanceChart() {
        const chartCtx = document.getElementById("studentPerformanceChart");
        if (!chartCtx) return;

        const literasiHistory = studentExerciseHistory.filter(
          (h) => h.exerciseType === "Literasi"
        );
        const numerasiHistory = studentExerciseHistory.filter(
          (h) => h.exerciseType === "Numerasi"
        );

        const latestLiterasiScores = literasiHistory
          .slice(0, 5)
          .reverse()
          .map((h) => h.score);
        const latestNumerasiScores = numerasiHistory
          .slice(0, 5)
          .reverse()
          .map((h) => h.score);

        const labels = Array.from(
          {
            length: Math.max(
              latestLiterasiScores.length,
              latestNumerasiScores.length
            ),
          },
          (_, i) => `Latihan ${i + 1}`
        );

        const data = {
          labels: labels,
          datasets: [
            {
              label: "Nilai Literasi",
              data: latestLiterasiScores,
              borderColor: "rgba(75, 192, 192, 1)",
              backgroundColor: "rgba(75, 192, 192, 0.2)",
              tension: 0.1,
              fill: false,
            },
            {
              label: "Nilai Numerasi",
              data: latestNumerasiScores,
              borderColor: "rgba(153, 102, 255, 1)",
              backgroundColor: "rgba(153, 102, 255, 0.2)",
              tension: 0.1,
              fill: false,
            },
          ],
        };

        if (studentPerformanceChart) {
          studentPerformanceChart.data = data;
          studentPerformanceChart.update();
        } else {
          studentPerformanceChart = new Chart(chartCtx, {
            type: "line",
            data: data,
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: "top",
                },
                title: {
                  display: true,
                  text: "Progres Nilai Latihan Terbaru",
                  font: {
                    size: 16,
                  },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    stepSize: 10,
                  },
                  title: {
                    display: true,
                    text: "Nilai (0-100)",
                  },
                },
                x: {
                  title: {
                    display: true,
                    text: "Urutan Latihan",
                  },
                },
              },
            },
          });
        }
      }

      /**
       * Submits the student's answers to the daily exercise.
       * @param {Event} e - The form submission event.
       */
      async function handleSubmitExercise(e) {
        e.preventDefault();
        showMessage("loading", "Mengirim jawaban dan mengevaluasi...");

        if (!studentData || !dailyExercise) {
          showMessage(
            "error",
            "Tidak dapat mengirim jawaban. Data siswa atau soal tidak ditemukan."
          );
          return;
        }

        const answers = dailyExercise.questions.map((q, index) => {
          const textarea = document.getElementById(`answer${index}`);
          return {
            question: q.question,
            answer: textarea ? textarea.value.trim() : "",
            minWords: q.minWords || 0,
          };
        });

        let totalScore = 0;
        let evaluationPrompt = `Sebagai seorang guru, evaluasi jawaban siswa berikut untuk latihan ${
          dailyExercise.type
        } pada tanggal ${
          dailyExercise.date
        }. Berikan nilai dari 0-100 untuk setiap jawaban, dan berikan saran yang membangun untuk membantu siswa meningkatkan pemahaman mereka. Pastikan saran relevan dengan jawaban siswa.

        Soal Latihan:
        ${
          dailyExercise.readingText
            ? `Bacaan: ${dailyExercise.readingText}\n\n`
            : ""
        }
        ${dailyExercise.questions
          .map(
            (q, index) =>
              `Soal ${index + 1}: ${q.question} (Minimal Kata: ${
                q.minWords || "N/A"
              })`
          )
          .join("\n")}

        Jawaban Siswa:
        ${answers
          .map((ans, index) => `Jawaban Soal ${index + 1}: ${ans.answer}`)
          .join("\n")}

        Format output harus sebagai berikut:
        Nilai Soal 1: [Nilai 0-100]
        Saran Soal 1: [Saran spesifik dan membangun]

        Nilai Soal 2: [Nilai 0-100]
        Saran Soal 2: [Saran spesifik dan membangun]

        ...dan seterusnya untuk semua soal.
        Di akhir, berikan ringkasan saran umum untuk seluruh latihan.
        Ringkasan Saran: [Saran umum untuk seluruh latihan]
        `;

        try {
          if (!GEMINI_API_KEY) {
            console.error("Error: GEMINI_API_KEY is not set.");
            showMessage(
              "error",
              "Kesalahan: Kunci API Gemini tidak diatur. Tidak dapat mengevaluasi jawaban."
            );
            return;
          }

          const payload = {
            contents: [{ parts: [{ text: evaluationPrompt }] }], // Use evaluationPrompt here
          };
          const response = await fetch(GEMINI_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          const aiEvaluationText = data.candidates[0].content.parts[0].text;

          const lines = aiEvaluationText
            .split("\n")
            .filter((line) => line.trim() !== "");
          let currentQuestionIndex = -1;
          let parsedScores = [];
          let parsedSuggestions = [];
          let overallSuggestion = "";

          lines.forEach((line) => {
            if (line.startsWith("Nilai Soal ")) {
              const match = line.match(/Nilai Soal (\d+):\s*(\d+)/);
              if (match) {
                currentQuestionIndex = parseInt(match[1]) - 1;
                parsedScores[currentQuestionIndex] = parseInt(match[2]);
              }
            } else if (line.startsWith("Saran Soal ")) {
              const match = line.match(/Saran Soal (\d+):\s*(.*)/);
              if (match) {
                const index = parseInt(match[1]) - 1;
                parsedSuggestions[index] = match[2].trim();
              }
              if (!parsedSuggestions[currentQuestionIndex]) {
                parsedSuggestions[currentQuestionIndex] =
                  "Tidak ada saran spesifik.";
              }
            } else if (line.startsWith("Ringkasan Saran:")) {
              overallSuggestion = line.replace("Ringkasan Saran:", "").trim();
            }
          });

          totalScore =
            parsedScores.reduce((sum, score) => sum + (score || 0), 0) /
            (parsedScores.length || 1);
          totalScore = Math.round(totalScore);

          const answersWithSuggestions = answers.map((ans, index) => ({
            ...ans,
            score: parsedScores[index] || 0,
            aiSuggestion:
              parsedSuggestions[index] || "Tidak ada saran spesifik.",
          }));

          await addDoc(collection(db, "student_exercise_history"), {
            studentId: studentData.id,
            exerciseId: dailyExercise.id,
            exerciseDate: dailyExercise.date,
            exerciseType: dailyExercise.type,
            answers: answersWithSuggestions,
            score: totalScore,
            aiSuggestions: overallSuggestion,
            timestamp: serverTimestamp(),
          });

          showMessage(
            "success",
            `Jawaban berhasil dikirim! Nilai Anda: ${totalScore}.`
          );

          renderDailyExerciseView();

          studentMotivation.message = null;
        } catch (error) {
          console.error("Error submitting exercise:", error);
          showMessage("error", `Gagal mengirim jawaban: ${error.message}`);
        }
      }

      function renderModals() {
        if (!modalContainer) {
          modalContainer = document.createElement("div");
          modalContainer.id = "modal-container";
          document.body.appendChild(modalContainer);
        }

        let modalHtml = "";

        if (showConfirmationModal) {
          modalHtml += `
            <div id="confirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[100] modal-overlay">
                <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm text-center">
                <h3 class="text-xl font-bold text-red-700 mb-4">Konfirmasi Aksi</h3>
                <p class="text-gray-700 mb-6">${confirmationMessage}</p>
                <div class="flex justify-center space-x-4">
                    <button type="button" id="cancelConfirm" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-xl hover:bg-gray-300 transition duration-200">
                    Batal
                    </button>
                    <button type="button" id="executeConfirm" class="px-6 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 transition duration-200">
                    Lanjutkan
                    </button>
                </div>
                </div>
            </div>
            `;
        }

        if (showAISuggestionsModal) {
          modalHtml += `
            <div id="aiSuggestionsModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-[1000] modal-overlay">
                <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-cyan-700">${aiSuggestionsTitle}</h3>
                        <button id="closeAISuggestionsModal" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">Ã—</button>
                    </div>
                    <div class="ai-reading-text">
                        <p>${aiSuggestionsContent.replace(/\n/g, "<br>")}</p>
                    </div>
                </div>
            </div>
            `;
        }

        if (showExerciseDetailsModal && exerciseDetailsData) {
          modalHtml += `
            <div id="exerciseDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-[1000] modal-overlay">
                <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-cyan-700">Detail Latihan (${
                          exerciseDetailsData.exerciseType
                        })</h3>
                        <button id="closeExerciseDetailsModal" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">Ã—</button>
                    </div>
                    <p class="text-gray-600 mb-4">Tanggal: ${
                      exerciseDetailsData.exerciseDate
                    } | Nilai: <strong>${
            exerciseDetailsData.score !== undefined
              ? exerciseDetailsData.score
              : "N/A"
          }</strong></p>
                    ${
                      exerciseDetailsData.dailyExercise?.readingText
                        ? `<div class="ai-reading-text mb-4"><h4 class="font-semibold text-cyan-700 mb-2">Bacaan:</h4><p>${exerciseDetailsData.dailyExercise.readingText.replace(
                            /\n/g,
                            "<br>"
                          )}</p></div>`
                        : ""
                    }
                    <div>
                        <h4 class="font-semibold text-cyan-700 mb-2">Soal & Jawaban Anda:</h4>
                        ${exerciseDetailsData.answers
                          .map(
                            (ans, index) => `
                            <div class="ai-question-item">
                                <p><strong>Soal ${index + 1}:</strong> ${
                              ans.question
                            }</p>
                                <p class="text-gray-700">Jawaban Anda: ${
                                  ans.answer
                                }</p>
                                <p class="text-gray-600 text-sm">Nilai: ${
                                  ans.score !== undefined ? ans.score : "N/A"
                                }</p>
                                ${
                                  ans.aiSuggestion
                                    ? `<p class="text-gray-600 text-sm italic">Saran AI: ${ans.aiSuggestion}</p>`
                                    : ""
                                }
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                    ${
                      exerciseDetailsData.aiSuggestions
                        ? `<div class="ai-reading-text mt-4"><h4 class="font-semibold text-cyan-700 mb-2">Ringkasan Saran AI:</h4><p>${exerciseDetailsData.aiSuggestions.replace(
                            /\n/g,
                            "<br>"
                          )}</p></div>`
                        : ""
                    }
                </div>
            </div>
            `;
        }

        modalContainer.innerHTML = modalHtml;
      }

      applySavedSettings();
    </script>
  </body>
</html>
