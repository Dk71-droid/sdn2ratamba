<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Latihanku</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <!-- Poppins font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f0f4f8; /* Light blue-gray background */
        color: #334155; /* Slate-700 text */
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        overflow-x: hidden; /* Prevent horizontal scroll */
      }

      .container {
        max-width: 960px;
        margin: 0 auto;
        padding: 1.25rem;
        width: 100%;
      }

      /* Responsive adjustments for container */
      @media (max-width: 767px) {
        /* For mobile devices */
        .container {
          padding: 0.5rem; /* Further reduced padding on small screens */
        }
      }

      .card {
        background-color: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        padding: 1.5rem;
        margin-bottom: 1.2rem;
      }
      @media (max-width: 767px) {
        .card {
          padding: 0.8rem; /* Reduced padding for mobile cards */
        }
      }
      .card-header {
        font-size: 1.25rem;
        font-weight: 600;
        color: #06b6d4; /* Cyan-700 */
        margin-bottom: 1rem;
      }

      /* Global Message Component Styles */
      #globalMessage {
        position: fixed;
        top: 0.75rem;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10000;
        padding: 0.6rem 0.8rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        max-width: 90%;
        width: 260px;
        text-align: left;
        font-size: 0.8rem;
      }
      #globalMessage.hidden {
        display: none;
      }
      #globalMessage.bg-green-100 {
        background-color: #d1fae5;
        border-color: #34d399;
        color: #065f46;
      }
      #globalMessage.bg-red-100 {
        background-color: #fee2e2;
        border-color: #ef4444;
        color: #991b1b;
      }
      #globalMessage.bg-blue-100 {
        background-color: #dbeafe;
        border-color: #3b82f6;
        color: #1e40af;
      }
      #globalMessage .font-bold {
        font-weight: 700;
        font-size: 0.85rem;
      }
      #globalMessage #messageCloseBtn {
        cursor: pointer;
        font-size: 1rem;
      }

      /* Page Transition Styles */
      #appView {
        opacity: 0; /* Start invisible */
        transition: opacity 0.5s ease-in-out; /* Smooth fade-in */
        width: 100%; /* Ensure it takes full width */
        display: flex; /* Make it a flex container */
        flex-direction: column; /* Stack its children vertically */
        flex-grow: 1; /* Allow it to take up available vertical space */
      }
      #appView.hidden {
        display: none; /* Truly hidden before fade-in starts */
      }
      #appView.fade-in {
        opacity: 1;
      }
      #appView.fade-out {
        opacity: 0;
        transition: opacity 0.3s ease-in-out; /* Faster fade-out */
      }

      /* New: Main view sections (login and app) */
      .full-screen-view {
        width: 100%;
        flex-grow: 1; /* Allow it to take up available vertical space */
        display: flex; /* Make it a flex container */
        flex-direction: column; /* Stack its children vertically */
        overflow-y: auto; /* Allow scrolling if content overflows */
        -webkit-overflow-scrolling: touch;
        background-color: #f0f4f8; /* Match body background */
      }

      /* Tab content sections */
      .tab-content-section {
        display: none; /* Hidden by default */
      }
      .tab-content-section.active {
        display: block; /* Only active section is shown */
      }

      /* AI Exercise specific styles */
      .ai-question-item {
        background-color: #f8fafc;
        padding: 0.7rem; /* Further reduced padding */
        border-radius: 0.5rem;
        margin-bottom: 0.7rem; /* Further reduced margin */
        border: 1px solid #e2e8f0;
        font-size: 0.8rem; /* Even smaller font for question items */
      }
      .ai-question-item p strong {
        color: #06b6d4;
      }
      .ai-question-item small {
        color: #64748b;
        font-style: italic;
        font-size: 0.7rem; /* Even smaller font for small text */
      }
      .ai-reading-text {
        background-color: #f0f9ff;
        padding: 0.7rem; /* Further reduced padding */
        border-left: 4px solid #06b6d4;
        border-radius: 0.5rem;
        margin-bottom: 1rem; /* Further reduced margin */
        line-height: 1.4; /* Further reduced line height */
        text-align: justify;
        font-size: 0.8rem; /* Even smaller font for reading text */
      }
      @media (max-width: 767px) {
        .ai-reading-text {
          font-size: 0.75rem; /* Smallest font on mobile */
          padding: 0.5rem; /* Smallest padding on mobile */
        }
      }
      .loading-spinner {
        display: inline-block;
        width: 18px; /* Slightly smaller spinner */
        height: 18px; /* Slightly smaller spinner */
        border: 2px solid rgba(255, 255, 255, 0.3); /* Thinner border */
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        -webkit-animation: spin 1s ease-in-out infinite;
        margin-left: 0.4rem; /* Reduced margin */
        vertical-align: middle;
      }

      @keyframes spin {
        to {
          -webkit-transform: rotate(360deg);
        }
      }
      @-webkit-keyframes spin {
        to {
          -webkit-transform: rotate(360deg);
        }
      }

      /* Table styles */
      .data-table {
        width: 100%;
        border-collapse: collapse;
      }
      .data-table th,
      .data-table td {
        padding: 0.5rem 0.6rem; /* Further reduced padding */
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
        font-size: 0.75rem; /* Even smaller font for table content */
      }
      .data-table th {
        background-color: #f8fafc;
        font-weight: 600;
        color: #475569;
        text-transform: uppercase;
        font-size: 0.7rem; /* Even smaller font for table headers */
      }
      @media (min-width: 768px) {
        .data-table td {
          font-size: 0.85rem; /* Slightly larger on desktop, but still smaller than before */
        }
      }
      .data-table tbody tr:hover {
        background-color: #f0f4f8;
      }
      .overflow-x-auto {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .data-table .actions-col {
        min-width: 80px; /* Further smaller min-width */
      }
      .data-table .actions-col button {
        padding: 0.15rem 0.3rem; /* Further reduced padding */
        font-size: 0.65rem; /* Even smaller font for action buttons */
      }

      /* Fixed Bottom Navigation */
      .bottom-nav {
        position: fixed; /* Keep it fixed */
        bottom: 0;
        left: 0;
        right: 0;
        background-color: white;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-around;
        padding: 0.3rem 0; /* Further reduced padding */
        z-index: 50;
      }
      .bottom-nav button {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.3rem 0.15rem; /* Further reduced padding */
        color: #64748b; /* Slate-600 */
        font-size: 0.6rem; /* Even smaller font for nav text */
        font-weight: 500;
        transition: color 0.2s ease;
        border-radius: 0.5rem;
      }
      .bottom-nav button.active {
        color: #06b6d4; /* Cyan-500 */
        font-weight: 600;
      }
      .bottom-nav button i {
        font-size: 1rem; /* Even smaller font for icons */
        margin-bottom: 0.1rem; /* Further reduced margin */
      }
      .bottom-nav button:hover {
        color: #06b6d4;
      }

      /* Portal Title (h1) adjustments */
      #portalTitle {
        font-size: 1.8rem; /* Default for desktop */
        text-align: right; /* Align to the right */
        flex-grow: 1; /* Allow it to take available space */
      }
      @media (max-width: 767px) {
        #portalTitle {
          font-size: 0.875rem; /* Significantly smaller for mobile (14px) */
        }
      }

      /* Dark Mode Styles */
      body.dark-mode {
        background-color: #1a202c; /* Dark background */
        color: #e2e8f0; /* Light text */
      }
      body.dark-mode .card {
        background-color: #2d3748; /* Darker card background */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      body.dark-mode .card-header {
        color: #4fd1c5; /* Teal-400 for headers */
      }
      body.dark-mode input,
      body.dark-mode textarea {
        background-color: #4a5568;
        border-color: #64748b;
        color: #e2e8f0;
      }
      body.dark-mode input::placeholder,
      body.dark-mode textarea::placeholder {
        color: #a0aec0;
      }
      body.dark-mode .bottom-nav {
        background-color: #2d3748;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
      }
      body.dark-mode .bottom-nav button {
        color: #cbd5e0;
      }
      body.dark-mode .bottom-nav button.active {
        color: #4fd1c5;
      }
      body.dark-mode .ai-question-item {
        background-color: #2d3748;
        border-color: #4a5568;
      }
      body.dark-mode .ai-question-item p strong {
        color: #4fd1c5;
      }
      body.dark-mode .ai-question-item small {
        color: #a0aec0;
      }
      body.dark-mode .ai-reading-text {
        background-color: #2d3748;
        border-left-color: #4fd1c5;
      }
      body.dark-mode .ai-reading-text h4 {
        color: #4fd1c5;
      }
      body.dark-mode .data-table th {
        background-color: #4a5568;
        color: #e2e8f0;
      }
      body.dark-mode .data-table tbody tr:hover {
        background-color: #4a5568;
      }
      body.dark-mode .modal-overlay .bg-white {
        background-color: #2d3748;
        color: #e2e8f0;
      }
      body.dark-mode .modal-overlay h3 {
        color: #4fd1c5;
      }
      body.dark-mode .modal-overlay .text-gray-700 {
        color: #e2e8f0;
      }
      body.dark-mode .modal-overlay .text-gray-500 {
        color: #a0aec0;
      }
      body.dark-mode #globalMessage.bg-blue-100 {
        background-color: #2c5282;
        border-color: #4299e1;
        color: #ebf8ff;
      }
      body.dark-mode #globalMessage.bg-green-100 {
        background-color: #2f855a;
        border-color: #48bb78;
        color: #ebf8ff;
      }
      body.dark-mode #globalMessage.bg-red-100 {
        background-color: #9b2c2c;
        border-color: #e53e3e;
        color: #fed7d7;
      }

      /* Reading Mode Styles */
      body.reading-mode {
        font-family: "Georgia", serif; /* Serif font for readability */
        line-height: 1.6; /* Further reduced line height */
        font-size: 1rem; /* Slightly smaller font size */
      }
      body.reading-mode .ai-reading-text,
      body.reading-mode .ai-question-item {
        font-size: 1rem; /* Adjust font size for content within reading mode */
      }
      body.reading-mode.dark-mode .ai-reading-text {
        background-color: #3e2723; /* Dark brown background for dark mode reading */
        border-left-color: #ffc107;
        color: #fff8e1;
      }
    </style>
  </head>
  <body>
    <!-- Global Message Component -->
    <div
      id="globalMessage"
      class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] p-4 rounded-md shadow-lg hidden max-w-sm w-full"
      role="alert"
    >
      <div class="flex justify-between items-center">
        <p id="messageTitle" class="font-bold"></p>
        <button id="messageCloseBtn" class="text-current text-lg font-bold">
          ×
        </button>
      </div>
      <p id="messageText"></p>
    </div>

    <!-- Main App View (Login view is removed from this file) -->
    <div id="appView" class="full-screen-view hidden">
      <div id="headerSection" class="container">
        <div class="flex justify-between items-center mb-6">
          <button
            id="backButton"
            class="text-slate-800 hover:text-cyan-600 transition duration-200 text-2xl"
          >
            <i class="fas fa-home"></i>
            <!-- Changed icon to home -->
          </button>
          <h1 class="font-bold text-slate-800" id="portalTitle">
            Aplikasi Latihanku Siswa
          </h1>
          <!-- Removed logout button from here -->
        </div>
      </div>

      <main class="container flex-grow pb-24">
        <!-- Added flex-grow and pb-24 for bottom nav space -->
        <!-- Dashboard View -->
        <div id="dashboardView" class="tab-content-section active">
          <!-- AI Motivation Card -->
          <div class="card mb-6">
            <h2 class="card-header">Saran & Motivasi AI untuk Anda</h2>
            <div id="aiMotivationContent" class="text-gray-700 text-sm">
              <!-- AI message or loading spinner will go here -->
              <div class="flex items-center justify-center py-4">
                <div class="loading-spinner"></div>
                <span class="ml-2">Memuat saran AI...</span>
              </div>
            </div>
          </div>
          <!-- Only one card for average score -->
          <div class="grid grid-cols-1 gap-4 mb-6" id="dashboardStatsContainer">
            <!-- Stats will be rendered here -->
          </div>
          <div class="card">
            <h2 class="card-header">Progres Latihan Saya</h2>
            <div class="relative h-64">
              <canvas id="studentPerformanceChart"></canvas>
            </div>
            <p class="text-xs text-gray-500 mt-4">
              Diagram ini menunjukkan progres nilai Anda untuk latihan Literasi
              dan Numerasi.
            </p>
          </div>
          <div class="card mt-6">
            <h2 class="card-header">Riwayat Latihan Terbaru</h2>
            <div id="recentActivitiesTableContainer" class="overflow-x-auto">
              <!-- Recent activities table will be rendered here -->
            </div>
          </div>
        </div>

        <!-- Latihan Harian View -->
        <div id="dailyExerciseView" class="tab-content-section">
          <div class="card">
            <h2 class="card-header">Latihan Harian AI</h2>
            <div id="dailyExerciseContent">
              <!-- Daily exercise content will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Riwayat Latihan View -->
        <div id="exerciseHistoryView" class="tab-content-section">
          <div class="card">
            <h2 class="card-header">Riwayat Latihan Saya</h2>
            <div id="exerciseHistoryTableContainer" class="overflow-x-auto">
              <!-- Exercise history table will be rendered here -->
            </div>
          </div>
        </div>

        <!-- Pengaturan View -->
        <div id="settingsView" class="tab-content-section">
          <div class="card">
            <h2 class="card-header">Pengaturan Tampilan</h2>
            <div class="flex items-center justify-between mb-4">
              <span>Mode Gelap:</span>
              <div class="flex space-x-2">
                <button
                  id="setLightMode"
                  class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl transition duration-200"
                >
                  Terang
                </button>
                <button
                  id="setDarkMode"
                  class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200"
                >
                  Gelap
                </button>
              </div>
            </div>
            <div class="flex items-center justify-between mb-4">
              <span>Mode Membaca:</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="toggleReadingMode"
                  class="sr-only peer"
                />
                <div
                  class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"
                ></div>
              </label>
            </div>
            <button
              id="resetSettings"
              class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-300 ease-in-out mb-4"
            >
              Reset Pengaturan
            </button>
            <!-- Moved logout button here -->
            <button
              id="logoutButton"
              class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-300 ease-in-out"
            >
              <i class="fas fa-sign-out-alt mr-2"></i> Keluar
            </button>
          </div>
        </div>
      </main>

      <!-- Fixed Bottom Navigation -->
      <nav class="bottom-nav" id="bottomNav">
        <button id="navDashboard" data-view="dashboard">
          <i class="fas fa-chart-pie"></i>
          <span>Dashboard</span>
        </button>
        <button id="navDailyExercise" data-view="dailyExercise">
          <i class="fas fa-book-open"></i>
          <span>Latihan</span>
        </button>
        <button id="navExerciseHistory" data-view="exerciseHistory">
          <i class="fas fa-history"></i>
          <span>Riwayat</span>
        </button>
        <button id="navSettings" data-view="settings">
          <i class="fas fa-cog"></i>
          <span>Pengaturan</span>
        </button>
      </nav>
    </div>

    <!-- Modal Container (for all modals) -->
    <div id="modal-container"></div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signInAnonymously,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        doc,
        getDoc,
        setDoc, // Import setDoc
        updateDoc,
        addDoc,
        onSnapshot,
        serverTimestamp,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

      // --- Firebase Configuration ---
      const firebaseConfig = {
        apiKey: "AIzaSyBWTYZH2OZuyq_mnbbxiap7iBg-17II55A",
        authDomain: "tabungansiswa-8bbd6.firebaseapp.com",
        projectId: "tabungansiswa-8bbd6",
        storageBucket: "tabungansiswa-8bbd6.firebaseastorage.app",
        messagingSenderId: "1068130708793",
        appId: "1:1068130708793:web:d6afeed38a9d42dd034ce8",
      };

      // Inisialisasi Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- Global State Variables ---
      let studentData = null; // Akan diisi dari Firestore berdasarkan ID di localStorage
      let studentMotivation = {
        message: null,
        lastGenerated: null,
        isGenerating: false,
      };
      let currentStudentView = "dashboard"; // 'dashboard', 'dailyExercise', 'exerciseHistory', 'settings'
      let dailyExercise = null;
      let studentExerciseHistory = [];
      let studentPerformanceChart = null;
      let hasAttemptedDailyGenerateStudent = false; // Flag to prevent multiple auto-generations per session

      // State untuk Modals
      let showConfirmationModal = false;
      let confirmationMessage = "";
      let confirmationAction = null;
      let showAISuggestionsModal = false;
      let aiSuggestionsContent = "";
      let aiSuggestionsTitle = "";
      let showExerciseDetailsModal = false;
      let exerciseDetailsData = null;

      // --- VERCEL SERVERLESS FUNCTION ENDPOINT ---
      // Ganti dengan URL deployment Vercel-mu.
      // Jika file gemini.js ada di folder 'api' di root proyek Vercel yang sama,
      // maka kamu bisa menggunakan path relatif '/api/gemini'.
      // Contoh: 'https://namaprojekmu.vercel.app/api/gemini'
      const VERCEL_GEMINI_API_ENDPOINT = "/api/gemini";

      // --- DOM Elements ---
      const appView = document.getElementById("appView");
      const portalTitle = document.getElementById("portalTitle");
      const bottomNav = document.getElementById("bottomNav");
      let modalContainer = document.getElementById("modal-container");

      // Global Message Component
      const globalMessage = document.getElementById("globalMessage");
      const messageTitle = document.getElementById("messageTitle");
      const messageText = document.getElementById("messageText");
      const messageCloseBtn = document.getElementById("messageCloseBtn");
      const backButton = document.getElementById("backButton"); // New back button

      // --- Helper Functions ---
      const showMessage = (type, text, titleOverride = null) => {
        globalMessage.classList.remove(
          "hidden",
          "bg-blue-100",
          "border-blue-500",
          "text-blue-700",
          "bg-green-100",
          "border-green-500",
          "text-green-700",
          "bg-red-100",
          "border-red-500",
          "text-red-700",
          "bg-gray-100",
          "border-gray-500",
          "text-gray-700"
        );

        let bgColor, borderColor, textColor, title;
        let duration = 3000;

        switch (type) {
          case "loading":
            bgColor = "bg-blue-100";
            borderColor = "border-blue-500";
            textColor = "text-blue-700";
            title = "Memuat...";
            break;
          case "success":
            bgColor = "bg-green-100";
            borderColor = "border-green-500";
            textColor = "text-green-700";
            title = "Berhasil!";
            break;
          case "error":
            bgColor = "bg-red-100";
            borderColor = "border-red-500";
            textColor = "text-red-700";
            title = "Terjadi Kesalahan!";
            duration = 5000;
            break;
          case "info":
            bgColor = "bg-blue-100";
            borderColor = "border-blue-500";
            textColor = "text-blue-700";
            title = "Informasi";
            break;
          default:
            bgColor = "bg-gray-100";
            borderColor = "border-gray-500";
            textColor = "text-gray-700";
            title = "";
        }

        messageTitle.innerText = titleOverride || title;
        globalMessage.classList.add(
          bgColor,
          `border-l-4`,
          borderColor,
          textColor
        );
        messageText.innerText = text;
        globalMessage.classList.remove("hidden");

        if (type !== "loading") {
          setTimeout(() => globalMessage.classList.add("hidden"), duration);
        }

        messageCloseBtn.onclick = () => globalMessage.classList.add("hidden");
      };

      function showConfirmModal(message, action) {
        confirmationMessage = message;
        confirmationAction = action;
        showConfirmationModal = true;
        renderModals();
        attachDynamicEventListeners();
      }

      // --- Theme Settings ---
      function applySavedSettings() {
        const theme = localStorage.getItem("studentTheme");
        if (theme === "dark") {
          document.body.classList.add("dark-mode");
        } else {
          document.body.classList.remove("dark-mode");
        }

        const readingMode = localStorage.getItem("studentReadingMode");
        const toggleReadingModeCheckbox =
          document.getElementById("toggleReadingMode");
        if (readingMode === "true") {
          document.body.classList.add("reading-mode");
          if (toggleReadingModeCheckbox)
            toggleReadingModeCheckbox.checked = true;
        } else {
          document.body.classList.remove("reading-mode");
          if (toggleReadingModeCheckbox)
            toggleReadingModeCheckbox.checked = false;
        }
      }

      function setLightMode() {
        localStorage.setItem("studentTheme", "light");
        applySavedSettings();
      }

      function setDarkMode() {
        localStorage.setItem("studentTheme", "dark");
        applySavedSettings();
      }

      function toggleReadingMode() {
        const isReadingMode = document.body.classList.toggle("reading-mode");
        localStorage.setItem(
          "studentReadingMode",
          isReadingMode ? "true" : "false"
        );
      }

      function resetSettings() {
        showConfirmModal(
          "Apakah Anda yakin ingin mereset semua pengaturan tampilan ke default?",
          () => {
            localStorage.removeItem("studentTheme");
            localStorage.removeItem("studentReadingMode");
            applySavedSettings();
            showMessage("success", "Pengaturan telah direset.");
          }
        );
      }

      // --- Firebase Auth State Listener ---
      onAuthStateChanged(auth, async (user) => {
        const studentAppIdFromLocalStorage = localStorage.getItem(
          "currentStudentAppId"
        );

        if (user) {
          // Pengguna Firebase ada. Sekarang, verifikasi ID siswa kustom kita di localStorage.
          if (studentAppIdFromLocalStorage) {
            const studentDocRef = doc(
              db,
              "users",
              studentAppIdFromLocalStorage
            );
            try {
              const docSnap = await getDoc(studentDocRef);
              if (docSnap.exists() && docSnap.data().role === "student") {
                // Sesi valid: Pengguna Firebase ada DAN ID siswa kustom valid
                studentData = { id: docSnap.id, ...docSnap.data() };
                setupFirestoreListeners(user.uid, studentData.id);
                renderMainContent();
                portalTitle.innerText = `Halo, ${studentData.name}!`;
                appView.classList.remove("hidden"); // Buat terlihat
                appView.classList.add("fade-in"); // Picu fade-in
              } else {
                // Pengguna Firebase ada, tapi ID siswa kustom tidak valid atau peran tidak sesuai
                console.warn(
                  "ID siswa tidak valid di localStorage atau peran tidak sesuai. Memaksa logout Firebase dan mengarahkan ke login."
                );
                localStorage.removeItem("currentStudentAppId"); // Hapus data tidak valid
                await signOut(auth); // Paksa logout Firebase
                window.location.href =
                  "login.html?redirect_to=latihankuv2.html"; // Arahkan ke login
              }
            } catch (error) {
              console.error(
                "Error mengambil data siswa dari Firestore:",
                error
              );
              localStorage.removeItem("currentStudentAppId");
              await signOut(auth);
              window.location.href = "login.html?redirect_to=latihankuv2.html";
            }
          } else {
            // Pengguna Firebase ada, tapi tidak ada ID siswa kustom di localStorage.
            // Ini berarti sesi Firebase aktif tetapi pengguna kustom kita tidak terhubung.
            console.warn(
              "Pengguna Firebase aktif tetapi tidak ada ID siswa di localStorage. Memaksa logout Firebase dan mengarahkan ke login."
            );
            await signOut(auth); // Paksa logout Firebase
            window.location.href = "login.html?redirect_to=latihankuv2.html"; // Arahkan ke login
          }
        } else {
          // Tidak ada pengguna Firebase. Pastikan localStorage bersih dan arahkan ke login.
          console.warn(
            "Tidak ada pengguna Firebase aktif. Mengarahkan ke login."
          );
          localStorage.removeItem("currentStudentAppId");
          window.location.href = "login.html?redirect_to=latihankuv2.html";
        }
      });

      // --- Firestore Listeners ---
      let unsubscribeStudentProfile;
      let unsubscribeDailyExercise;
      let unsubscribeStudentExerciseHistory;
      let unsubscribeStudentMotivation;

      function setupFirestoreListeners(firebaseAuthUid, studentAppId) {
        // Berhenti berlangganan dari listener sebelumnya untuk mencegah kebocoran memori dan pembaruan duplikat
        if (unsubscribeStudentProfile) unsubscribeStudentProfile();
        if (unsubscribeDailyExercise) unsubscribeDailyExercise();
        if (unsubscribeStudentExerciseHistory)
          unsubscribeStudentExerciseHistory();
        if (unsubscribeStudentMotivation) unsubscribeStudentMotivation();

        // Listener untuk profil siswa sendiri (koleksi users)
        if (studentAppId) {
          const studentDocRef = doc(db, "users", studentAppId);
          unsubscribeStudentProfile = onSnapshot(
            studentDocRef,
            (docSnap) => {
              if (docSnap.exists() && docSnap.data().role === "student") {
                studentData = { id: docSnap.id, ...docSnap.data() };
                if (studentData.isGeneratingMotivation === undefined) {
                  studentData.isGeneratingMotivation = false;
                }
                if (
                  currentStudentView === "dashboard" ||
                  currentStudentView === "settings"
                ) {
                  renderDashboardView();
                  renderSettingsView();
                }
                portalTitle.innerText = `Halo, ${studentData.name}!`;
              } else {
                console.log(
                  "Tidak ada data siswa ditemukan untuk pengguna saat ini atau peran bukan siswa, atau ID tidak cocok! Memaksa logout."
                );
                signOut(auth);
              }
            },
            (error) => {
              console.error("Error mengambil data siswa:", error);
              showMessage("error", "Gagal memuat data profil siswa.");
            }
          );
        } else {
          console.warn(
            "setupFirestoreListeners dipanggil untuk profil siswa tanpa studentAppId yang valid."
          );
        }

        // Listener untuk pesan motivasi siswa (menggunakan UID Firebase Auth sebagai ID dokumen)
        if (firebaseAuthUid) {
          const studentMotivationDocRef = doc(
            db,
            "student_motivation_messages",
            firebaseAuthUid
          );
          unsubscribeStudentMotivation = onSnapshot(
            studentMotivationDocRef,
            (docSnap) => {
              if (docSnap.exists()) {
                studentMotivation.message = docSnap.data().message;
                studentMotivation.lastGenerated = docSnap
                  .data()
                  .lastGenerated?.toDate();
              } else {
                studentMotivation.message = null;
                studentMotivation.lastGenerated = null;
              }
              if (currentStudentView === "dashboard") {
                renderDashboardView();
              }
            },
            (error) => {
              console.error("Error mengambil pesan motivasi siswa:", error);
              showMessage("error", "Gagal memuat pesan motivasi AI.");
            }
          );
        } else {
          console.warn(
            "setupFirestoreListeners dipanggil untuk motivasi tanpa firebaseAuthUid yang valid."
          );
        }

        // Listener untuk latihan AI hari ini (tidak bergantung pada ID siswa)
        const todayDate = new Date().toISOString().slice(0, 10);
        const dailyExerciseDocRef = doc(db, "daily_ai_exercises", todayDate);
        unsubscribeDailyExercise = onSnapshot(
          dailyExerciseDocRef,
          async (docSnap) => {
            if (docSnap.exists()) {
              dailyExercise = { id: docSnap.id, ...docSnap.data() };
            } else {
              dailyExercise = null;
              // NEW: Automatic generation if no exercise for today and not yet attempted by this student
              if (
                !hasAttemptedDailyGenerateStudent &&
                studentData && // Ensure studentData is loaded
                auth.currentUser // Ensure Firebase user is authenticated
              ) {
                hasAttemptedDailyGenerateStudent = true; // Set flag to prevent re-triggering
                showMessage(
                  "info",
                  "Latihan harian untuk hari ini belum ada. Mencoba menggenerate otomatis..."
                );
                const dailyTypeForToday = getDailyExerciseTypeForAI(todayDate);
                await generateAndSaveDailyExercise(
                  todayDate,
                  dailyTypeForToday,
                  true // isAutoGenerate set to true
                );
              }
            }
            if (currentStudentView === "dailyExercise") {
              renderDailyExerciseView();
            }
          },
          (error) => {
            console.error("Error mengambil latihan harian:", error);
            showMessage("error", "Gagal memuat soal latihan harian.");
          }
        );

        // Listener untuk riwayat latihan siswa (menggunakan studentAppId)
        if (studentAppId) {
          const studentHistoryQuery = query(
            collection(db, "student_exercise_history"),
            where("studentId", "==", studentAppId)
          );
          unsubscribeStudentExerciseHistory = onSnapshot(
            studentHistoryQuery,
            (snapshot) => {
              studentExerciseHistory = snapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
              // --- LOGGING UNTUK DIAGNOSA ---
              console.log(
                "Fetched studentExerciseHistory:",
                studentExerciseHistory
              );
              // --- END LOGGING ---
              studentExerciseHistory.sort((a, b) => {
                const timestampA = a.timestamp
                  ? a.timestamp.toDate
                    ? a.timestamp.toDate()
                    : new Date(a.timestamp)
                  : new Date(0);
                const timestampB = b.timestamp
                  ? b.timestamp.toDate
                    ? b.timestamp.toDate()
                    : new Date(b.timestamp)
                  : new Date(0);
                return timestampB - timestampA;
              });
              if (
                currentStudentView === "dashboard" ||
                currentStudentView === "exerciseHistory"
              ) {
                renderDashboardView();
                renderExerciseHistoryView();
              }
            },
            (error) => {
              console.error("Error mengambil riwayat latihan siswa:", error);
              showMessage("error", "Gagal memuat riwayat latihan Anda.");
            }
          );
        } else {
          console.warn(
            "setupFirestoreListeners dipanggil untuk riwayat latihan tanpa studentAppId yang valid."
          );
        }
      }

      async function handleLogout() {
        showConfirmModal("Apakah Anda yakin ingin keluar?", async () => {
          showMessage("loading", "Sedang logout...");
          try {
            await signOut(auth);
            studentData = null;
            localStorage.removeItem("currentStudentAppId"); // Hapus ID siswa kustom dari localStorage
            studentMotivation = {
              message: null,
              lastGenerated: null,
              isGenerating: false,
            };
            dailyExercise = null;
            studentExerciseHistory = [];
            currentStudentView = "dashboard";
            hasAttemptedDailyGenerateStudent = false; // Reset flag
            if (studentPerformanceChart) {
              studentPerformanceChart.destroy();
              studentPerformanceChart = null;
            }

            // Bersihkan status modal
            showConfirmationModal = false;
            confirmationMessage = "";
            confirmationAction = null;
            showAISuggestionsModal = false;
            aiSuggestionsContent = "";
            aiSuggestionsTitle = "";
            showExerciseDetailsModal = false;
            exerciseDetailsData = null;

            // Berhenti berlangganan semua listener
            if (unsubscribeStudentProfile) unsubscribeStudentProfile();
            if (unsubscribeDailyExercise) unsubscribeDailyExercise();
            if (unsubscribeStudentExerciseHistory)
              unsubscribeStudentExerciseHistory();
            if (unsubscribeStudentMotivation) unsubscribeStudentMotivation();

            showMessage("success", "Berhasil logout.");
            appView.classList.add("fade-out"); // Terapkan fade-out sebelum pengalihan
            setTimeout(() => {
              window.location.href = "portalsiswa.html"; // Arahkan ke portal login
            }, 300); // Sesuaikan dengan durasi transisi CSS
          } catch (error) {
            console.error("Error logout:", error);
            showMessage("error", "Gagal logout: " + error.message);
          }
        });
      }

      // --- Main Content Renderer ---
      function renderMainContent() {
        // Di latihankuv2.html, kita berasumsi pengguna sudah terautentikasi atau akan diarahkan.
        // Jadi, kita langsung menampilkan appView dan kontennya.
        bottomNav.style.display = "flex"; // Pastikan navigasi bawah terlihat

        // Sembunyikan semua bagian konten tab internal di dalam appView terlebih dahulu
        document
          .querySelectorAll("#appView .tab-content-section")
          .forEach((section) => {
            section.classList.remove("active");
          });

        // Tampilkan bagian konten tab internal yang aktif saat ini
        const activeViewElement = document.getElementById(
          `${currentStudentView}View`
        );
        if (activeViewElement) {
          activeViewElement.classList.add("active");
        }

        // Atur kelas aktif untuk tombol navigasi bawah
        document.querySelectorAll(".bottom-nav button").forEach((button) => {
          if (button.dataset.view === currentStudentView) {
            button.classList.add("active");
          } else {
            button.classList.remove("active");
          }
        });

        // Panggil fungsi render spesifik untuk tampilan aktif
        switch (currentStudentView) {
          case "dashboard":
            renderDashboardView();
            break;
          case "dailyExercise":
            renderDailyExerciseView();
            break;
          case "exerciseHistory":
            renderExerciseHistoryView();
            break;
          case "settings":
            renderSettingsView();
            break;
        }
        renderModals();
        attachDynamicEventListeners();
      }

      // --- Sub-renderers untuk setiap tampilan ---
      function renderDashboardView() {
        const dashboardViewElement = document.getElementById("dashboardView");
        if (!dashboardViewElement) return;

        const totalLiterasiScores = studentExerciseHistory
          .filter((h) => (h.exerciseType || "").toLowerCase() === "literasi") // Penanganan defensif
          .reduce((sum, h) => sum + (h.score || 0), 0);
        const totalLiterasiCount = studentExerciseHistory.filter(
          (h) => (h.exerciseType || "").toLowerCase() === "literasi" // Penanganan defensif
        ).length;

        const totalNumerasiScores = studentExerciseHistory
          .filter((h) => (h.exerciseType || "").toLowerCase() === "numerasi") // Penanganan defensif
          .reduce((sum, h) => sum + (h.score || 0), 0);
        const totalNumerasiCount = studentExerciseHistory.filter(
          (h) => (h.exerciseType || "").toLowerCase() === "numerasi" // Penanganan defensif
        ).length;

        const overallAverageScore = (
          (totalLiterasiScores + totalNumerasiScores) /
          (totalLiterasiCount + totalNumerasiCount || 1)
        ).toFixed(0);

        const dashboardStatsHtml = `
            <div class="card bg-gradient-to-br from-cyan-500 to-cyan-600 text-white">
                <p class="text-sm opacity-90">Rata-rata Nilai Keseluruhan</p>
                <p class="text-3xl font-bold mt-2">${overallAverageScore}</p>
            </div>
        `;
        document.getElementById("dashboardStatsContainer").innerHTML =
          dashboardStatsHtml;

        const recentActivities = studentExerciseHistory.slice(0, 5);
        const recentActivitiesTableHtml = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Jenis Latihan</th>
                        <th>Nilai</th>
                        <th class="actions-col">Saran AI</th>
                    </tr>
                </thead>
                <tbody>
                    ${recentActivities
                      .map(
                        (activity) => `
                            <tr>
                                <td>${activity.exerciseDate}</td>
                                <td>${
                                  activity.exerciseType || "N/A"
                                }</td> <!-- Penanganan defensif -->
                                <td>${
                                  activity.score !== undefined
                                    ? activity.score
                                    : "N/A"
                                }</td>
                                <td class="actions-col">
                                    <button class="text-blue-500 hover:text-blue-700 text-sm view-ai-suggestions-btn" data-history-id="${
                                      activity.id
                                    }">
                                        <i class="fas fa-comment"></i> Lihat Saran
                                    </button>
                                </td>
                            </tr>
                        `
                      )
                      .join("")}
                    ${
                      recentActivities.length === 0
                        ? `<tr><td colspan="4" class="text-center text-gray-500">Belum ada riwayat latihan.</td></tr>`
                        : ""
                    }
                </tbody>
            </table>
        `;
        document.getElementById("recentActivitiesTableContainer").innerHTML =
          recentActivitiesTableHtml;

        renderStudentPerformanceChart();

        const aiMotivationContentDiv = document.getElementById(
          "aiMotivationContent"
        );
        if (!studentData) {
          aiMotivationContentDiv.innerHTML = `<p class="text-gray-600 text-sm">Silakan login untuk melihat saran AI.</p>`;
          return;
        }

        if (studentMotivation.message) {
          aiMotivationContentDiv.innerHTML = `<p class="text-gray-700 text-sm">${studentMotivation.message.replace(
            /\n/g,
            "<br>"
          )}</p>`;
        } else if (
          studentExerciseHistory.length > 0 &&
          !studentMotivation.isGenerating
        ) {
          studentMotivation.isGenerating = true;
          aiMotivationContentDiv.innerHTML = `
                <div class="flex items-center justify-center py-4">
                    <div class="loading-spinner"></div>
                    <span class="ml-2">Memuat saran AI...</span>
                </div>
            `;
          generateAndSaveMotivationMessage(
            overallAverageScore,
            totalLiterasiCount,
            totalNumerasiCount,
            studentExerciseHistory
          )
            .then(() => {})
            .catch((error) => {
              console.error("Error generating AI motivation message:", error);
              aiMotivationContentDiv.innerHTML = `<p class="text-red-500 text-sm">Gagal memuat saran AI: ${error.message}</p>`;
            })
            .finally(() => {
              studentMotivation.isGenerating = false;
            });
        } else if (studentExerciseHistory.length === 0) {
          aiMotivationContentDiv.innerHTML = `<p class="text-gray-600 text-sm">Selesaikan latihan pertama Anda untuk mendapatkan saran AI!</p>`;
        }

        document
          .querySelectorAll(".view-ai-suggestions-btn")
          .forEach((button) => {
            button.addEventListener("click", (e) => {
              const historyId = e.currentTarget.dataset.historyId;
              const historyItem = studentExerciseHistory.find(
                (item) => item.id === historyId
              );
              if (historyItem && historyItem.aiSuggestions) {
                showAISuggestionsModal = true;
                aiSuggestionsContent = historyItem.aiSuggestions;
                aiSuggestionsTitle = "Saran AI untuk Latihan Ini";
                renderModals();
                attachDynamicEventListeners();
              } else {
                showMessage(
                  "info",
                  "Tidak ada saran AI untuk latihan ini.",
                  "Info"
                );
              }
            });
          });
      }

      async function generateAndSaveMotivationMessage(
        overallAverageScore,
        totalLiterasiCount,
        totalNumerasiCount,
        history
      ) {
        const aiMotivationContentDiv = document.getElementById(
          "aiMotivationContent"
        );
        if (!aiMotivationContentDiv) return;

        const oneMonthAgo = new Date();
        oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

        const recentHistorySummary = history
          .filter((h) => {
            const timestamp = h.timestamp
              ? h.timestamp.toDate
                ? h.timestamp.toDate()
                : new Date(h.timestamp)
              : new Date(0);
            return timestamp >= oneMonthAgo;
          })
          .slice(0, 5)
          .map((h) => {
            return `Tanggal: ${h.exerciseDate}, Jenis: ${
              h.exerciseType || "N/A" // Penanganan defensif
            }, Nilai: ${h.score}, Saran Sebelumnya: ${
              h.aiSuggestions || "Tidak ada saran."
            }`;
          })
          .join("\n");

        // --- START OF PROMPT MODIFICATION ---
        const prompt = `Sebagai seorang teman atau kakak yang peduli, tolong berikan pesan motivasi dan saran singkat (maksimal 3-4 kalimat) kepada siswa ini. Gunakan bahasa sehari-hari yang santai, akrab, dan dekat dengan siswa. Pesan harus berdasarkan riwayat latihan terakhirnya (dalam 1 bulan terakhir, maksimal 5 entri) dan rata-rata nilai.
        
        Penting: Nilai yang diberikan adalah dalam rentang 1-100.
        
        Kriteria Penilaian:
        - Nilai 0-49: Perlu banyak peningkatan.
        - Nilai 50-69: Perlu peningkatan.
        - Nilai 70-84: Baik.
        - Nilai 85-100: Sangat Baik.

        Fokus pada semangat untuk terus belajar dan berkembang, dan sebutkan secara umum area yang bisa ditingkatkan kalau ada pola dari saran-saran sebelumnya. Sesuaikan nada motivasi berdasarkan rata-rata nilai keseluruhan siswa.

Riwayat Latihan Terakhir (dalam 1 bulan, maksimal 5 entri):
${recentHistorySummary || "Belum ada riwayat latihan dalam 1 bulan terakhir."}

Rata-rata Nilai Keseluruhan: ${overallAverageScore}
`;
        // --- END OF PROMPT MODIFICATION ---

        try {
          // Panggil serverless function di Vercel
          const response = await fetch(VERCEL_GEMINI_API_ENDPOINT, {
            method: "POST", // PASTIKAN INI ADA DAN BENAR
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: prompt }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              `Panggilan API gagal dengan status ${response.status}: ${
                errorData.error || "Kesalahan tidak diketahui"
              }`
            );
          }

          const data = await response.json();
          // Ambil teks dari properti 'text' di respons Vercel.
          // Fungsi gemini.js yang telah diperbarui akan selalu mengembalikan { text: "..." } jika tidak ada responseSchema.
          const aiMessage = data.text;

          if (auth.currentUser) {
            await setDoc(
              doc(db, "student_motivation_messages", auth.currentUser.uid),
              {
                message: aiMessage || "", // Pastikan tidak undefined
                lastGenerated: serverTimestamp(),
                studentAppId: studentData.id,
              },
              { merge: true }
            );
          } else {
            throw new Error(
              "Tidak ada pengguna Firebase yang terautentikasi untuk menyimpan pesan motivasi."
            );
          }
        } catch (error) {
          console.error(
            "Error menghasilkan dan menyimpan pesan motivasi AI:",
            error
          );
          aiMotivationContentDiv.innerHTML = `<p class="text-red-500 text-sm">Gagal memuat saran AI: ${error.message}</p>`;
        } finally {
          studentMotivation.isGenerating = false;
        }
      }

      /**
       * Determines the daily exercise type for AI app based on a given date.
       * This is a helper for the AI app admin view.
       * @param {string} dateString - Date in YYYY-MM-DD format.
       * @returns {string} 'Literasi' atau 'Numerasi'.
       */
      function getDailyExerciseTypeForAI(dateString) {
        const date = new Date(dateString);
        return date.getDate() % 2 === 0 ? "Literasi" : "Numerasi";
      }

      /**
       * Parses the raw content generated by the Gemini API for Literasi exercises.
       * @param {string} generatedContent - The raw text content from Gemini.
       * @returns {{readingText: string, questions: Array<Object>}} - Parsed reading text and questions.
       */
      function parseLiterasiContent(generatedContent) {
        let readingText = "";
        const questions = [];

        // Split content into parts based on "Soal X:" pattern
        const parts = generatedContent.split(/Soal \d+:\s*/).filter(Boolean); // Filter out empty strings

        // First part should be the reading text
        const readingMatch = parts[0].match(/Bacaan:\s*([\s\S]*)/i);
        if (readingMatch && readingMatch[1]) {
          readingText = readingMatch[1].trim();
        } else {
          // Fallback: If "Bacaan:" not found, assume the first part is the reading text
          readingText = parts[0].trim();
        }

        // Subsequent parts are questions
        for (let i = 1; i < parts.length; i++) {
          const blockContent = parts[i];
          if (blockContent) {
            const questionLines = blockContent
              .split("\n")
              .map((line) => line.trim())
              .filter(Boolean);
            const questionText = questionLines[0]; // First line is the question

            let minWords = 0;
            const minWordsLine = questionLines.find((line) =>
              line.includes("Minimal Kata Jawaban:")
            );
            if (minWordsLine) {
              const minWordsMatch = minWordsLine.match(
                /Minimal Kata Jawaban:\s*(\d+)/
              );
              if (minWordsMatch && minWordsMatch[1]) {
                minWords = parseInt(minWordsMatch[1]);
              }
            }
            if (isNaN(minWords) || minWords <= 0) {
              minWords = 10; // Default minimum words
            }
            questions.push({ question: questionText, minWords: minWords });
          }
        }
        return { readingText, questions };
      }

      /**
       * Parses the raw content generated by the Gemini API for Numerasi exercises.
       * @param {string} generatedContent - The raw text content from Gemini.
       * @returns {{questions: Array<Object>}} - Parsed questions.
       */
      function parseNumerasiContent(generatedContent) {
        const questions = [];
        // Use regex to find all lines starting with "Soal X:"
        const questionMatches = generatedContent.match(/Soal \d+:\s*([^\n]+)/g);

        if (questionMatches) {
          questionMatches.forEach((match) => {
            const questionText = match.replace(/Soal \d+:\s*/, "").trim();
            if (questionText) {
              questions.push({ question: questionText });
            }
          });
        }
        return { questions };
      }

      /**
       * Generates and saves a daily exercise for students using Gemini API via a backend endpoint.
       * This is triggered automatically when a student views the daily exercise page and no exercise exists for today.
       * @param {string} targetDate - The date for which to generate the exercise (YYYY-MM-DD).
       * @param {string} exerciseType - The type of exercise to generate ('Literasi' or 'Numerasi').
       */
      async function generateAndSaveDailyExercise(
        targetDate,
        exerciseType,
        isAutoGenerate = false
      ) {
        showMessage(
          "loading",
          `Mencoba menggenerate soal AI ${exerciseType} untuk ${targetDate} secara otomatis...`
        );

        const docRef = doc(db, "daily_ai_exercises", targetDate);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          // If it already exists, another user might have generated it concurrently.
          // Just update the dailyExercise state and return.
          dailyExercise = { id: docSnap.id, ...docSnap.data() };
          showMessage(
            "info",
            `Soal ${dailyExercise.type} untuk ${targetDate} sudah tersedia.`
          );
          renderDailyExerciseView();
          return;
        }

        let prompt = "";
        if (exerciseType === "Literasi") {
          prompt = `Buatlah 1 bacaan pendek yang cocok untuk siswa SD kelas 5 (sekitar 150-200 kata) terdiri dari 3 paragraf. Gunakan bahasa yang sederhana dan mudah dipahami. Tema bacaan bisa berupa cerita fiksi, pengetahuan umum, atau deskripsi tentang sesuatu yang menarik bagi anak-anak.
                Setelah bacaan, buat 3 soal terbuka yang memantik pemikiran kritis dan meningkatkan pemahaman literasi siswa.
                - Soal 1: Mudah (pertanyaan langsung dari teks)
                - Soal 2: Sedang (membutuhkan sedikit penalaran atau inferensi)
                - Soal 3: Sulit (membutuhkan pemikiran mendalam, analisis, atau menghubungkan ide)
                Sertakan juga di akhir setiap setiap soal, "Minimal Kata Jawaban: [jumlah angka, misal 15]".
                Format output:
                Bacaan: [isi bacaan paragraf 1]
                [isi bacaan paragraf 2]
                [isi bacaan paragraf 3]
                Soal 1: [pertanyaan mudah]
                Minimal Kata Jawaban: [jumlah kata]
                Soal 2: [pertanyaan sedang]
                Minimal Kata Jawaban: [jumlah kata]
                Soal 3: [pertanyaan sulit]
                Minimal Kata Jawaban: [jumlah kata]
                `;
        } else {
          // Numerasi
          prompt = `Buatlah 5 soal cerita matematika untuk siswa SD kelas 3-4. Soal melibatkan operasi dasar (penjumlahan, pengurangan, perkalian, pembagian) dan sederhana. Jangan berikan jawaban atau penjelasan. Format output:
                Soal 1: [soal cerita]
                Soal 2: [soal cerita]
                Soal 3: [soal cerita]
                Soal 4: [soal cerita]
                Soal 5: [soal cerita]
                `;
        }

        try {
          const response = await fetch(VERCEL_GEMINI_API_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: prompt }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              `HTTP error! status: ${response.status}, message: ${
                errorData.error || "Unknown error"
              }`
            );
          }

          const data = await response.json();
          const generatedContent = data.text;

          let parsedResult;
          if (exerciseType === "Literasi") {
            parsedResult = parseLiterasiContent(generatedContent);
          } else {
            parsedResult = parseNumerasiContent(generatedContent);
          }

          await setDoc(doc(db, "daily_ai_exercises", targetDate), {
            date: targetDate,
            type: exerciseType,
            rawContent: generatedContent,
            readingText: parsedResult.readingText || "",
            questions: parsedResult.questions,
            generatedBy: "system-student-trigger", // Mark as generated by student trigger
            generatedByName: "Sistem Otomatis",
            timestamp: serverTimestamp(),
          });

          showMessage(
            "success",
            `Soal ${exerciseType} untuk ${targetDate} berhasil digenerate dan disimpan!`
          );
          // Listener akan secara otomatis memperbarui dailyExercise dan me-render ulang
        } catch (error) {
          console.error("Error generating and saving daily exercise:", error);
          showMessage("error", `Gagal generate soal AI: ${error.message}`);
        }
      }

      function renderDailyExerciseView() {
        const dailyExerciseViewElement =
          document.getElementById("dailyExerciseView");
        if (!dailyExerciseViewElement) return;

        const dailyExerciseContentDiv = document.getElementById(
          "dailyExerciseContent"
        );
        if (!dailyExerciseContentDiv) return;

        const todayDate = new Date().toISOString().slice(0, 10);
        const hasCompletedToday = studentExerciseHistory.some(
          (history) =>
            history.exerciseDate === todayDate &&
            history.studentId === studentData.id
        );

        if (dailyExercise) {
          if (hasCompletedToday) {
            const todayHistory = studentExerciseHistory.find(
              (history) =>
                history.exerciseDate === todayDate &&
                history.studentId === studentData.id
            );
            dailyExerciseContentDiv.innerHTML = `
              <h3 class="text-lg font-semibold text-slate-700 mb-3">Latihan Harian ${
                dailyExercise.type
              } (${dailyExercise.date})</h3>
              <p class="text-green-600 font-semibold mb-2">Anda telah menyelesaikan latihan ini untuk hari ini!</p>
              <p class="text-green-600 font-semibold mb-4">Nilai Anda: <strong>${
                todayHistory.score !== undefined ? todayHistory.score : "N/A"
              }</strong></p>
              ${
                dailyExercise.readingText
                  ? `
                <div class="ai-reading-text mt-4">
                    <h4 class="font-semibold text-cyan-700 mb-2">Bacaan:</h4>
                    <p>${dailyExercise.readingText.replace(/\n/g, "<br>")}</p>
                </div>`
                  : ""
              }
              <div>
                  <h4 class="font-semibold text-cyan-700 mb-2">Soal & Jawaban Anda:</h4>
                  ${todayHistory.answers
                    .map(
                      (ans, index) => `
                      <div class="ai-question-item">
                          <p><strong>Soal ${index + 1}:</strong> ${
                        ans.question
                      }</p>
                          <p class="text-gray-700">Jawaban Anda: ${
                            ans.answer
                          }</p>
                          <p class="text-gray-600 text-xs">Nilai: ${
                            ans.score !== undefined ? ans.score : "N/A"
                          }</p>
                          ${
                            ans.aiSuggestion
                              ? `<p class="text-gray-600 text-xs italic">Saran AI: ${ans.aiSuggestion}</p>`
                              : ""
                          }
                      </div>
                  `
                    )
                    .join("")}
              </div>
              ${
                todayHistory.aiSuggestions
                  ? `
                <div class="ai-reading-text mt-4">
                    <h4 class="font-semibold text-cyan-700 mb-2">Ringkasan Saran AI:</h4>
                    <p>${todayHistory.aiSuggestions.replace(/\n/g, "<br>")}</p>
                </div>
              `
                  : ""
              }
              <p class="text-sm text-gray-500 mt-4">Silakan kembali besok untuk latihan baru!</p>
            `;
          } else {
            const exerciseHtml = `
              <h3 class="text-lg font-semibold text-slate-700 mb-3">Soal Latihan ${
                dailyExercise.type
              } (${dailyExercise.date})</h3>
              ${
                dailyExercise.readingText
                  ? `<div class="ai-reading-text mb-4"><h4 class="font-semibold text-cyan-700 mb-2">Bacaan:</h4><p>${dailyExercise.readingText.replace(
                      /\n/g,
                      "<br>"
                    )}</p></div>`
                  : ""
              }
              <form id="exerciseForm" class="space-y-4">
                ${dailyExercise.questions
                  .map(
                    (q, index) => `
                  <div class="ai-question-item">
                    <p><strong>Soal ${index + 1}:</strong> ${
                      q.question
                    } <small>${
                      q.minWords ? `(Min. ${q.minWords} kata)` : ""
                    }</small></p>
                    <textarea id="answer${index}" class="w-full p-2 border border-gray-300 rounded-md mt-2 focus:ring-cyan-500 focus:border-cyan-500" rows="3" placeholder="Tulis jawaban Anda di sini..." required></textarea>
                  </div>
                `
                  )
                  .join("")}
                <button type="submit" id="submitExerciseBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-300 ease-in-out">
                  Kirim Jawaban
                </button>
              </form>
            `;
            dailyExerciseContentDiv.innerHTML = exerciseHtml;

            document
              .getElementById("exerciseForm")
              ?.addEventListener("submit", handleSubmitExercise);
          }
        } else {
          dailyExerciseContentDiv.innerHTML = `
            <p class="text-gray-600">Belum ada latihan harian yang tersedia untuk hari ini.</p>
            <p class="text-sm text-gray-500 mt-2">Sistem akan mencoba menggenerate soal otomatis. Jika tidak muncul, silakan hubungi guru Anda.</p>
          `;
        }
      }

      function renderExerciseHistoryView() {
        const exerciseHistoryViewElement = document.getElementById(
          "exerciseHistoryView"
        );
        if (!exerciseHistoryViewElement) return;

        const exerciseHistoryTableContainer = document.getElementById(
          "exerciseHistoryTableContainer"
        );
        if (!exerciseHistoryTableContainer) return;

        if (studentExerciseHistory.length > 0) {
          const tableHtml = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Tanggal</th>
                  <th>Jenis Latihan</th>
                  <th>Nilai</th>
                  <th class="actions-col">Aksi</th>
                </tr>
              </thead>
              <tbody>
                ${studentExerciseHistory
                  .map(
                    (history) => `
                  <tr>
                    <td>${history.exerciseDate}</td>
                    <td>${
                      history.exerciseType || "N/A"
                    }</td> <!-- Penanganan defensif -->
                    <td>${
                      history.score !== undefined ? history.score : "N/A"
                    }</td>
                    <td class="actions-col">
                      <button class="text-blue-500 hover:text-blue-700 text-sm view-exercise-details-btn" data-history-id="${
                        history.id
                      }">
                        <i class="fas fa-eye"></i> Lihat Detail
                      </button>
                    </td>
                  </tr>
                `
                  )
                  .join("")}
              </tbody>
            </table>
          `;
          exerciseHistoryTableContainer.innerHTML = tableHtml;

          document
            .querySelectorAll(".view-exercise-details-btn")
            .forEach((button) => {
              button.addEventListener("click", (e) => {
                const historyId = e.currentTarget.dataset.historyId;
                const historyItem = studentExerciseHistory.find(
                  (item) => item.id === historyId
                );
                if (historyItem) {
                  exerciseDetailsData = historyItem;
                  showExerciseDetailsModal = true;
                  renderModals();
                  attachDynamicEventListeners();
                }
              });
            });
        } else {
          exerciseHistoryTableContainer.innerHTML = `<p class="text-gray-600">Anda belum menyelesaikan latihan apa pun.</p>`;
        }
      }

      function renderSettingsView() {
        const settingsViewElement = document.getElementById("settingsView");
        if (!settingsViewElement) return;

        applySavedSettings();

        document
          .getElementById("setLightMode")
          ?.removeEventListener("click", setLightMode);
        document
          .getElementById("setLightMode")
          ?.addEventListener("click", setLightMode);

        document
          .getElementById("setDarkMode")
          ?.removeEventListener("click", setDarkMode);
        document
          .getElementById("setDarkMode")
          ?.addEventListener("click", setDarkMode);

        document
          .getElementById("toggleReadingMode")
          ?.removeEventListener("change", toggleReadingMode);
        document
          .getElementById("toggleReadingMode")
          ?.addEventListener("change", toggleReadingMode);

        document
          .getElementById("resetSettings")
          ?.removeEventListener("click", resetSettings);
        document
          .getElementById("resetSettings")
          ?.addEventListener("click", resetSettings);

        // Lampirkan listener tombol logout (sekarang di pengaturan)
        document
          .getElementById("logoutButton")
          ?.removeEventListener("click", handleLogout);
        document
          .getElementById("logoutButton")
          ?.addEventListener("click", handleLogout);
      }

      // --- Lampirkan Event Listener untuk Konten yang Dirender Secara Dinamis ---
      function attachDynamicEventListeners() {
        document.querySelectorAll(".bottom-nav button").forEach((button) => {
          button.removeEventListener("click", handleNavButtonClick);
          button.addEventListener("click", handleNavButtonClick);
        });

        // Listener tombol logout sekarang ditangani di renderSettingsView
        // document.getElementById("logoutButton")?.removeEventListener("click", handleLogout);
        // document.getElementById("logoutButton")?.addEventListener("click", handleLogout);

        // Baru: Listener tombol kembali
        backButton?.removeEventListener("click", handleBackButtonClick);
        backButton?.addEventListener("click", handleBackButtonClick);

        if (showConfirmationModal) {
          document
            .getElementById("cancelConfirm")
            ?.removeEventListener("click", handleCancelConfirm);
          document
            .getElementById("cancelConfirm")
            ?.addEventListener("click", handleCancelConfirm);
          document
            .getElementById("executeConfirm")
            ?.removeEventListener("click", handleExecuteConfirm);
          document
            .getElementById("executeConfirm")
            ?.addEventListener("click", handleExecuteConfirm);
        }
        if (showAISuggestionsModal) {
          document
            .getElementById("closeAISuggestionsModal")
            ?.removeEventListener("click", handleCloseAISuggestionsModal);
          document
            .getElementById("closeAISuggestionsModal")
            ?.addEventListener("click", handleCloseAISuggestionsModal);
        }
        if (showExerciseDetailsModal) {
          document
            .getElementById("closeExerciseDetailsModal")
            ?.removeEventListener("click", handleCloseExerciseDetailsModal);
          document
            .getElementById("closeExerciseDetailsModal")
            ?.addEventListener("click", handleCloseExerciseDetailsModal);
        }
      }

      function handleNavButtonClick(e) {
        currentStudentView = e.currentTarget.dataset.view;
        renderMainContent();
      }

      // Baru: Tangani klik tombol kembali
      function handleBackButtonClick() {
        appView.classList.add("fade-out"); // Terapkan efek fade-out
        setTimeout(() => {
          window.location.href = "portalsiswa.html"; // Arahkan kembali ke portalsiswa.html
        }, 300); // Sesuaikan dengan durasi transisi CSS
      }

      function handleCancelConfirm() {
        showConfirmationModal = false;
        confirmationMessage = "";
        confirmationAction = null;
        renderModals();
      }

      function handleExecuteConfirm() {
        if (confirmationAction) {
          confirmationAction();
        }
        showConfirmationModal = false;
        confirmationAction = null;
        renderModals();
      }

      function handleCloseAISuggestionsModal() {
        showAISuggestionsModal = false;
        aiSuggestionsContent = "";
        aiSuggestionsTitle = "";
        renderModals();
      }

      function handleCloseExerciseDetailsModal() {
        showExerciseDetailsModal = false;
        exerciseDetailsData = null;
        renderModals();
      }

      // --- Rendering Chart untuk Dashboard ---
      function renderStudentPerformanceChart() {
        const chartCtx = document.getElementById("studentPerformanceChart");
        if (!chartCtx) return;

        const literasiHistory = studentExerciseHistory.filter(
          (h) => (h.exerciseType || "").toLowerCase() === "literasi" // Penanganan defensif
        );
        const numerasiHistory = studentExerciseHistory.filter(
          (h) => (h.exerciseType || "").toLowerCase() === "numerasi" // Penanganan defensif
        );

        const latestLiterasiScores = literasiHistory
          .slice(0, 5)
          .reverse()
          .map((h) => h.score);
        const latestNumerasiScores = numerasiHistory
          .slice(0, 5)
          .reverse()
          .map((h) => h.score);

        const labels = Array.from(
          {
            length: Math.max(
              latestLiterasiScores.length,
              latestNumerasiScores.length
            ),
          },
          (_, i) => `Latihan ${i + 1}`
        );

        const data = {
          labels: labels,
          datasets: [
            {
              label: "Nilai Literasi",
              data: latestLiterasiScores,
              borderColor: "rgba(75, 192, 192, 1)",
              backgroundColor: "rgba(75, 192, 192, 0.2)",
              tension: 0.1,
              fill: false,
            },
            {
              label: "Nilai Numerasi",
              data: latestNumerasiScores,
              borderColor: "rgba(153, 102, 255, 1)",
              backgroundColor: "rgba(153, 102, 255, 0.2)",
              tension: 0.1,
              fill: false,
            },
          ],
        };

        if (studentPerformanceChart) {
          // Mengubah scoreChart menjadi studentPerformanceChart
          studentPerformanceChart.data = data;
          studentPerformanceChart.update();
        } else {
          studentPerformanceChart = new Chart(chartCtx, {
            // Mengubah scoreChart menjadi studentPerformanceChart
            type: "line",
            data: data,
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: "top",
                  labels: {
                    color: document.body.classList.contains("dark-mode")
                      ? "#e2e8f0"
                      : "#334155",
                  },
                },
                title: {
                  display: true,
                  text: "Progres Nilai Latihan Terbaru",
                  font: {
                    size: 16,
                  },
                  color: document.body.classList.contains("dark-mode")
                    ? "#e2e8f0"
                    : "#334155",
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    stepSize: 10,
                    color: document.body.classList.contains("dark-mode")
                      ? "#cbd5e1"
                      : "#475569",
                  },
                  title: {
                    display: true,
                    text: "Nilai (0-100)",
                    color: document.body.classList.contains("dark-mode")
                      ? "#e2e8f0"
                      : "#334155",
                  },
                },
                x: {
                  ticks: {
                    color: document.body.classList.contains("dark-mode")
                      ? "#cbd5e1"
                      : "#475569",
                  },
                  title: {
                    display: true,
                    text: "Urutan Latihan",
                    color: document.body.classList.contains("dark-mode")
                      ? "#e2e8f0"
                      : "#334155",
                  },
                },
              },
            },
          });
        }
      }

      /**
       * Mengirim jawaban siswa ke latihan harian.
       * @param {Event} e - Event pengiriman formulir.
       */
      async function handleSubmitExercise(e) {
        e.preventDefault();
        showMessage("loading", "Mengirim jawaban dan mengevaluasi...");

        if (!studentData || !dailyExercise) {
          showMessage(
            "error",
            "Tidak dapat mengirim jawaban. Data siswa atau soal tidak ditemukan."
          );
          return;
        }

        const answers = dailyExercise.questions.map((q, index) => {
          const textarea = document.getElementById(`answer${index}`);
          return {
            question: q.question,
            answer: textarea ? textarea.value.trim() : "",
            minWords: q.minWords || 0,
          };
        });

        let evaluationPrompt = `Sebagai seorang guru, evaluasi jawaban siswa berikut untuk latihan ${
          dailyExercise.type
        } pada tanggal ${
          dailyExercise.date
        }. Berikan nilai dari 0-100 untuk setiap jawaban, dan berikan saran yang membangun untuk membantu siswa meningkatkan pemahaman mereka. Pastikan saran relevan dengan jawaban siswa.

        Soal Latihan:
        ${
          dailyExercise.readingText
            ? `Bacaan: ${dailyExercise.readingText}\n\n`
            : ""
        }
        ${dailyExercise.questions
          .map(
            (q, index) =>
              `Soal ${index + 1}: ${q.question} (Minimal Kata: ${
                q.minWords || "N/A"
              })`
          )
          .join("\n")}

        Jawaban Siswa:
        ${answers
          .map((ans, index) => `Jawaban Soal ${index + 1}: ${ans.answer}`)
          .join("\n")}

        Format respons dalam JSON object dengan properti "gradedQuestions" (array of objects) dan "overallSuggestions" (string).
        Setiap objek di "gradedQuestions" harus memiliki "questionIndex" (int, dimulai dari 0), "score" (int, 0-100), dan "aiSuggestion" (string).
        Contoh:
        {
          "gradedQuestions": [
            { "questionIndex": 0, "score": 80, "aiSuggestion": "Perlu lebih detail pada bagian X." },
            { "questionIndex": 1, "score": 100, "aiSuggestion": "Bagus sekali!" }
          ],
          "overallSuggestions": "Secara keseluruhan, pemahaman Anda baik, namun perlu fokus pada konsep Y."
        }
        `;

        try {
          // --- LOGGING WAKTU: Mulai panggilan API Gemini ---
          console.time("Gemini API Call Duration");
          const response = await fetch(VERCEL_GEMINI_API_ENDPOINT, {
            method: "POST", // PASTIKAN INI ADA DAN BENAR
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              prompt: evaluationPrompt,
              generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                  type: "OBJECT",
                  properties: {
                    gradedQuestions: {
                      type: "ARRAY",
                      items: {
                        type: "OBJECT",
                        properties: {
                          questionIndex: { type: "NUMBER" },
                          score: { type: "NUMBER" },
                          aiSuggestion: { type: "STRING" },
                        },
                      },
                    },
                    overallSuggestions: { type: "STRING" },
                  },
                },
              },
            }),
          });
          console.timeEnd("Gemini API Call Duration"); // --- LOGGING WAKTU: Akhir panggilan API Gemini ---

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              `Panggilan API gagal dengan status ${response.status}: ${
                errorData.error || "Kesalahan tidak diketahui"
              }`
            );
          }

          // gemini.js yang telah diperbarui akan mengembalikan JSON yang sudah di-parse langsung
          const gradingResult = await response.json();

          if (
            !gradingResult ||
            !gradingResult.gradedQuestions ||
            !Array.isArray(gradingResult.gradedQuestions)
          ) {
            throw new Error("Format respons penilaian AI tidak valid.");
          }

          let updatedAnswers = dailyExercise.questions.map((q, index) => {
            const studentAnswer = answers.find(
              (ans) => ans.question === q.question
            );
            const gradedQ = gradingResult.gradedQuestions.find(
              (gQ) => gQ.questionIndex === index
            );

            return {
              question: q.question,
              answer: studentAnswer ? studentAnswer.answer : "", // Jawaban siswa
              score: gradedQ && gradedQ.score !== undefined ? gradedQ.score : 0, // Pastikan score tidak undefined
              aiSuggestion:
                gradedQ && gradedQ.aiSuggestion !== undefined
                  ? gradedQ.aiSuggestion
                  : "", // Pastikan aiSuggestion tidak undefined
              minWords: q.minWords || 0,
            };
          });

          let sumScores = updatedAnswers.reduce(
            (sum, ans) => sum + ans.score,
            0
          );
          const totalScore =
            updatedAnswers.length > 0
              ? (sumScores / updatedAnswers.length).toFixed(0)
              : 0;

          // --- LOGGING WAKTU: Mulai penyimpanan Firestore ---
          console.time("Firestore Save Duration");
          console.log(
            "Saving student exercise history with type:",
            dailyExercise.type
          );
          await addDoc(collection(db, "student_exercise_history"), {
            studentId: studentData.id,
            exerciseDate: dailyExercise.date,
            exerciseType: dailyExercise.type,
            score: parseInt(totalScore),
            answers: updatedAnswers,
            aiSuggestions: gradingResult.overallSuggestions || "", // Pastikan overallSuggestions tidak undefined
            timestamp: serverTimestamp(),
          });
          console.timeEnd("Firestore Save Duration"); // --- LOGGING WAKTU: Akhir penyimpanan Firestore ---

          showMessage(
            "success",
            "Penilaian selesai! Hasil telah disimpan.",
            "Berhasil!"
          );
          // Render ulang tampilan latihan harian untuk menunjukkan hasil
          renderDailyExerciseView();
        } catch (error) {
          console.error("Error menilai jawaban:", error);
          showMessage("error", `Gagal menilai jawaban: ${error.message}`);
        }
      }

      function renderModals() {
        let modalHtml = "";

        if (showConfirmationModal) {
          modalHtml += `
            <div class="modal-overlay fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Konfirmasi</h3>
                    <p class="text-gray-700 mb-6">${confirmationMessage}</p>
                    <div class="flex justify-center space-x-4">
                        <button id="cancelConfirm" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-xl transition duration-200">Batal</button>
                        <button id="executeConfirm" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl transition duration-200">Ya, Lanjutkan</button>
                    </div>
                </div>
            </div>
            `;
        }

        if (showAISuggestionsModal) {
          modalHtml += `
            <div class="modal-overlay fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-cyan-700">${aiSuggestionsTitle}</h3>
                        <button id="closeAISuggestionsModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <div class="ai-reading-text">
                        <p>${aiSuggestionsContent.replace(/\n/g, "<br>")}</p>
                    </div>
                </div>
            </div>
            `;
        }

        if (showExerciseDetailsModal && exerciseDetailsData) {
          modalHtml += `
            <div class="modal-overlay fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-cyan-700">Detail Latihan</h3>
                        <button id="closeExerciseDetailsModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <div class="exercise-info text-gray-700 mb-4 text-sm">
                        <p><strong>Topik:</strong> ${
                          exerciseDetailsData.topic || "N/A" // Penanganan defensif
                        }</p>
                        <p><strong>Jenis:</strong> ${
                          exerciseDetailsData.exerciseType || "N/A" // Penanganan defensif
                        }</p>
                        <p><strong>Tanggal:</strong> ${
                          exerciseDetailsData.exerciseDate
                        }</p>
                        ${
                          exerciseDetailsData.score !== undefined
                            ? `<p><strong>Nilai Total:</strong> <span class="text-cyan-600 font-bold">${exerciseDetailsData.score}</span></p>`
                            : ""
                        }
                    </div>
                    <div class="answer-section">
                        <h4 class="text-lg font-semibold text-cyan-700 mb-3">Pertanyaan & Jawaban Anda</h4>
                        <div class="graded-answers space-y-4">
                            ${exerciseDetailsData.answers
                              .map(
                                (ans, index) => `
                            <div class="ai-question-item p-3">
                                <p class="font-semibold text-gray-800"><strong>Soal ${
                                  index + 1
                                }:</strong> ${ans.question}</p>
                                <p class="text-gray-700">Jawaban Anda: ${
                                  ans.answer
                                }</p>
                                <p class="text-gray-600 text-sm">Nilai: ${
                                  ans.score !== undefined ? ans.score : "N/A"
                                }</p>
                                ${
                                  ans.aiSuggestion
                                    ? `<p class="text-gray-600 text-sm italic">Saran AI: ${ans.aiSuggestion}</p>`
                                    : ""
                                }
                            </div>
                        `
                              )
                              .join("")}
                    </div>
                    ${
                      exerciseDetailsData.aiSuggestions
                        ? `<div class="ai-reading-text mt-4"><h4 class="font-semibold text-cyan-700 mb-2">Ringkasan Saran AI:</h4><p>${exerciseDetailsData.aiSuggestions.replace(
                            /\n/g,
                            "<br>"
                          )}</p></div>`
                        : ""
                    }
                </div>
            </div>
            `;
        }

        modalContainer.innerHTML = modalHtml;
      }

      applySavedSettings();
    </script>
  </body>
</html>
