<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trik Cepat Pembagian</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Ensure html and body take full height */
      html,
      body {
        height: 100%;
      }

      /* Custom styles for card flip animation */
      .flip-card {
        perspective: 1000px;
        width: 100%; /* Make it fluid */
        max-width: 300px; /* Max width for larger screens */
        height: 200px; /* Fixed height for consistent vertical positioning */
        margin: auto; /* Center horizontally */
      }

      .flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.6s;
        transform-style: preserve-3d;
      }

      /* This is crucial for the automatic flip */
      .flip-card.flipped .flip-card-inner {
        transform: rotateY(180deg);
      }

      .flip-card-front,
      .flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden; /* Safari */
        backface-visibility: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-radius: 0.75rem; /* rounded-lg */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
        padding: 1rem;
      }

      .flip-card-front {
        background-color: #f0f9ff; /* bg-sky-50 */
        color: #1e40af; /* text-blue-800 */
      }

      .flip-card-back {
        background-color: #dbeafe; /* bg-blue-100 */
        color: #1e40af; /* text-blue-800 */
        transform: rotateY(180deg); /* Essential for the back face */
      }

      /* Ensure Inter font is used */
      body {
        font-family: "Inter", sans-serif;
      }

      /* Styles for feedback messages inside the card */
      .card-feedback-message {
        /* Changed to class for both front/back */
        font-size: 1.25rem; /* text-xl */
        font-weight: bold;
        margin-top: 0.5rem; /* pt-2 */
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem; /* rounded-md */
        display: none; /* Hidden by default */
      }
      .card-feedback-message.feedback-correct {
        background-color: #d1fae5; /* bg-green-100 */
        color: #065f46; /* text-green-800 */
      }
      .card-feedback-message.feedback-incorrect {
        background-color: #fee2e2; /* bg-red-100 */
        color: #991b1b; /* text-red-800 */
      }

      /* Style for the trick hint text */
      #trick-description-display {
        background-color: #fffbeb; /* bg-amber-50 */
        border: 1px solid #fcd34d; /* border-amber-300 */
        color: #b45309; /* text-amber-700 */
        padding: 0.75rem;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem; /* Reduced margin-bottom */
        font-size: 0.9rem;
        text-align: center;
        width: 100%;
      }

      /* Level Button Styling */
      .level-button {
        background-color: #6366f1; /* indigo-500 - this will be overridden by JS */
        /* Removed 'color: white;' to allow dynamic text color */
        font-weight: bold;
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: background-color 0.2s, transform 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .level-button:hover:not(:disabled) {
        /* This will be overridden by JS for unlocked buttons */
        background-color: #4f46e5; /* indigo-600 */
        transform: translateY(-2px);
      }

      .level-button:disabled {
        background-color: #cbd5e1; /* slate-300 */
        color: #64748b; /* slate-600 */
        cursor: not-allowed;
        box-shadow: none;
      }

      /* Icon for locked levels */
      .level-button.locked svg {
        fill: #64748b; /* slate-600 */
      }

      /* Modal Styles */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-content {
        background-color: #fff;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        max-width: 90%;
        max-height: 90%;
        overflow-y: auto;
        position: relative;
      }

      .modal-close-button {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
      }
    </style>
    <!-- Font Awesome for Lock Icon -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>
  <body class="bg-blue-50 flex flex-col h-screen">
    <!-- Main App Container -->
    <div
      id="app-container"
      class="bg-white rounded-lg shadow-2xl w-full mx-auto flex flex-col flex-grow sm:p-6 p-2 overflow-y-auto max-w-md md:max-w-3xl lg:max-w-5xl xl:max-w-full"
    >
      <!-- Main Category & Level Selection Screen -->
      <div
        id="main-selection-screen"
        class="w-full text-center flex flex-col flex-grow pt-4"
      >
        <h1 class="text-3xl font-bold text-blue-800 mb-6 flex-shrink-0">
          Pilih Level Trik Pembagian
        </h1>

        <!-- Overall Progress Summary -->
        <div
          id="overall-progress-summary"
          class="bg-indigo-100 text-indigo-800 font-semibold py-2 px-4 rounded-lg mb-4 mx-auto w-full max-w-xs"
        >
          <!-- Progress text will be inserted here by JavaScript -->
        </div>

        <!-- Level Progress Visualizer (Minimalist Graph) -->
        <div
          id="level-progress-visualizer"
          class="flex justify-center items-center gap-2 mb-6 flex-wrap"
        >
          <!-- Dots will be injected here by JavaScript -->
        </div>

        <!-- The flex-grow and overflow-y-auto on category-list should now work correctly -->
        <div
          id="category-and-level-list"
          class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto flex-grow pb-8 min-h-0"
        >
          <!-- Categories and Level buttons will be injected here by JavaScript -->
        </div>
      </div>

      <!-- Game Screen (Hidden by default) -->
      <div id="game-screen" class="hidden w-full flex flex-col flex-grow">
        <!-- Header Bar -->
        <div
          class="flex justify-between items-center p-2 mb-2 bg-white rounded-t-lg"
        >
          <button
            id="back-arrow-button"
            class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-110"
          >
            &larr;
          </button>
          <h2
            id="current-level-title"
            class="text-xl font-semibold text-blue-700"
          ></h2>
          <!-- Timer Display -->
          <div id="timer-display" class="text-lg font-bold text-red-600"></div>
        </div>

        <!-- Instruction Hint for Level 5 -->
        <div
          id="level5-instruction-hint"
          class="hidden bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg mb-4 mx-auto w-full max-w-xs text-center"
        >
          Fokuslah menghafal pola soal ini! Ini adalah dasar trik selanjutnya.
        </div>

        <!-- Progress Bar -->
        <div
          id="progress-container"
          class="w-full bg-gray-200 rounded-full h-2.5 mb-2"
        >
          <div
            id="progress-bar"
            class="bg-blue-600 h-2.5 rounded-full"
            style="width: 0%"
          ></div>
        </div>

        <!-- Main Content Area - This needs to be flexible -->
        <div
          class="flex flex-col items-center justify-start px-2 min-h-0 overflow-y-auto"
        >
          <!-- Trick Description Display -->
          <div id="trick-description-display" class="hidden w-full mb-1 mt-1">
            <p class="font-bold mb-1">Trik yang Digunakan:</p>
            <p id="current-trick-text"></p>
          </div>

          <!-- Card Container -->
          <div id="flash-card" class="flip-card mb-1">
            <div class="flip-card-inner">
              <div class="flip-card-front">
                <p class="text-5xl font-bold mb-2" id="question-text">?</p>
                <!-- Feedback message for incorrect answers -->
                <p
                  id="card-feedback-message-front"
                  class="card-feedback-message"
                ></p>
              </div>
              <div class="flip-card-back">
                <p class="text-5xl font-bold mb-2" id="answer-text"></p>
                <!-- Feedback message for correct answers -->
                <p
                  id="card-feedback-message-back"
                  class="card-feedback-message"
                ></p>
              </div>
            </div>
          </div>

          <!-- Score Display for Test Level -->
          <div
            id="test-score-display"
            class="hidden bg-blue-100 text-blue-800 font-bold py-2 px-4 rounded-lg shadow-md mb-4 w-full max-w-xs text-center"
          >
            Skor: <span id="current-score">0</span> /
            <span id="total-test-questions">0</span>
          </div>

          <!-- Feedback Message (Removed from here, now inside card) -->
        </div>

        <!-- Input Methods - This should be fixed at the bottom -->
        <div
          class="flex flex-col gap-3 w-full max-w-xs mx-auto px-2 pb-2 flex-shrink-0 mt-1"
        >
          <input
            type="number"
            id="manual-input"
            placeholder="Ketik jawaban di sini..."
            class="p-3 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-lg"
          />
          <!-- Tombol Kirim Jawaban telah dihapus -->
        </div>
      </div>

      <!-- Hafalan Screen (Hidden by default) -->
      <div
        id="hafalan-screen"
        class="hidden w-full flex flex-col flex-grow items-center justify-center p-4 text-center"
      >
        <h2
          id="hafalan-title"
          class="text-3xl font-bold text-purple-700 mb-6"
        ></h2>
        <div
          id="hafalan-trick-display"
          class="bg-purple-50 border-2 border-purple-300 text-purple-800 p-4 rounded-lg shadow-md max-w-md mx-auto mb-8"
        >
          <p class="font-bold text-xl mb-2">Trik:</p>
          <p id="hafalan-trick-text" class="text-lg"></p>
        </div>
        <button
          id="hafalan-complete-button"
          class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
        >
          Saya Sudah Hafal!
        </button>
      </div>
    </div>

    <!-- Instruction Modal (Hidden by default) -->
    <div id="instruction-modal" class="modal-backdrop hidden">
      <div class="modal-content">
        <button class="modal-close-button" id="modal-close-button">
          &times;
        </button>
        <h2 id="modal-title" class="text-2xl font-bold text-blue-700 mb-4"></h2>
        <div
          id="modal-instruction-text"
          class="text-gray-700 text-base leading-relaxed"
        >
          <!-- Instruction content will be injected here -->
        </div>
      </div>
    </div>

    <script type="module">
      // Firebase Imports
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Global Firebase variables
      let app;
      let db;
      let auth;
      let userId;
      // Changed initial value to 0 to unlock the first playable level by default
      let highestCompletedLevel = 0;

      // Test specific variables
      let testScore = 0;
      const totalTestQuestions = 10;
      let isTestLevel = false;

      // Timer variables
      let timerInterval;
      let timeRemaining;
      const questionTimeLimit = 15; // Waktu batas untuk setiap soal (detik)

      // Firebase Configuration (provided by Canvas environment)
      const firebaseConfig =
        typeof __firebase_config !== "undefined"
          ? JSON.parse(__firebase_config)
          : {};
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      const initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      // Data soal dan trik untuk setiap level
      const allOriginalQuestions = {
        "A.1": [
          { q: "2 ÷ 2", a: "1", trik: "A.1" },
          { q: "4 ÷ 2", a: "2", trik: "A.1" },
          { q: "6 ÷ 2", a: "3", trik: "A.1" },
          { q: "8 ÷ 2", a: "4", trik: "A.1" },
        ],
        "A.2": [
          { q: "20 ÷ 2", a: "10", trik: "A.2" },
          { q: "40 ÷ 2", a: "20", trik: "A.2" },
          { q: "60 ÷ 2", a: "30", trik: "A.2" },
          { q: "80 ÷ 2", a: "40", trik: "A.2" },
          { q: "100 ÷ 2", a: "50", trik: "A.2" },
        ],
        "A.3": [
          { q: "10 ÷ 2", a: "5", trik: "A.3" },
          { q: "30 ÷ 2", a: "15", trik: "A.3" },
          { q: "50 ÷ 2", a: "25", trik: "A.3" },
          { q: "70 ÷ 2", a: "35", trik: "A.3" },
          { q: "90 ÷ 2", a: "45", trik: "A.3" },
        ],
        // New A.4.even and A.4.odd based on original A.4.b
        "A.4.even": [
          { q: "22 ÷ 2", a: "11", trik: "A.4.even" },
          { q: "24 ÷ 2", a: "12", trik: "A.4.even" },
          { q: "26 ÷ 2", a: "13", trik: "A.4.even" },
          { q: "28 ÷ 2", a: "14", trik: "A.4.even" },
          { q: "42 ÷ 2", a: "21", trik: "A.4.even" },
          { q: "44 ÷ 2", a: "22", trik: "A.4.even" },
          { q: "46 ÷ 2", a: "23", trik: "A.4.even" },
          { q: "48 ÷ 2", a: "24", trik: "A.4.even" },
          { q: "62 ÷ 2", a: "31", trik: "A.4.even" },
          { q: "64 ÷ 2", a: "32", trik: "A.4.even" },
          { q: "66 ÷ 2", a: "33", trik: "A.4.even" },
          { q: "68 ÷ 2", a: "34", trik: "A.4.even" },
          { q: "82 ÷ 2", a: "41", trik: "A.4.even" },
          { q: "84 ÷ 2", a: "42", trik: "A.4.even" },
          { q: "86 ÷ 2", a: "43", trik: "A.4.even" },
          { q: "88 ÷ 2", a: "44", trik: "A.4.even" },
        ],
        "A.4.odd.basic": [
          // New entry for basic odd tens division
          { q: "12 ÷ 2", a: "6", trik: "A.4.odd" },
          { q: "14 ÷ 2", a: "7", trik: "A.4.odd" },
          { q: "16 ÷ 2", a: "8", trik: "A.4.odd" },
          { q: "18 ÷ 2", a: "9", trik: "A.4.odd" },
        ],
        "A.4.odd.full": [
          // Full set of odd tens division
          { q: "12 ÷ 2", a: "6", trik: "A.4.odd" },
          { q: "14 ÷ 2", a: "7", trik: "A.4.odd" },
          { q: "16 ÷ 2", a: "8", trik: "A.4.odd" },
          { q: "18 ÷ 2", a: "9", trik: "A.4.odd" },
          { q: "32 ÷ 2", a: "16", trik: "A.4.odd" },
          { q: "34 ÷ 2", a: "17", trik: "A.4.odd" },
          { q: "36 ÷ 2", a: "18", trik: "A.4.odd" },
          { q: "38 ÷ 2", a: "19", trik: "A.4.odd" },
          { q: "52 ÷ 2", a: "26", trik: "A.4.odd" },
          { q: "54 ÷ 2", a: "27", trik: "A.4.odd" },
          { q: "56 ÷ 2", a: "28", trik: "A.4.odd" },
          { q: "58 ÷ 2", a: "29", trik: "A.4.odd" },
          { q: "72 ÷ 2", a: "36", trik: "A.4.odd" },
          { q: "74 ÷ 2", a: "37", trik: "A.4.odd" },
          { q: "76 ÷ 2", a: "38", trik: "A.4.odd" },
          { q: "78 ÷ 2", a: "39", trik: "A.4.odd" },
          { q: "92 ÷ 2", a: "46", trik: "A.4.odd" },
          { q: "94 ÷ 2", a: "47", trik: "A.4.odd" },
          { q: "96 ÷ 2", a: "48", trik: "A.4.odd" },
          { q: "98 ÷ 2", a: "49", trik: "A.4.odd" },
        ],
        "B.2": [
          { q: "3 ÷ 3", a: "1", trik: "B.2" },
          { q: "6 ÷ 3", a: "2", trik: "B.2" },
          { q: "9 ÷ 3", a: "3", trik: "B.2" },
          { q: "12 ÷ 3", a: "4", trik: "B.2" },
          { q: "15 ÷ 3", a: "5", trik: "B.2" },
          { q: "18 ÷ 3", a: "6", trik: "B.2" },
          { q: "21 ÷ 3", a: "7", trik: "B.2" },
          { q: "24 ÷ 3", a: "8", trik: "B.2" },
          { q: "27 ÷ 3", a: "9", trik: "B.2" },
          { q: "30 ÷ 3", a: "10", trik: "B.2" },
          { q: "33 ÷ 3", a: "11", trik: "B.2" },
          { q: "36 ÷ 3", a: "12", trik: "B.2" },
          { q: "39 ÷ 3", a: "13", trik: "B.2" },
          { q: "42 ÷ 3", a: "14", trik: "B.2" },
          { q: "45 ÷ 3", a: "15", trik: "B.2" },
          { q: "48 ÷ 3", a: "16", trik: "B.2" },
          { q: "51 ÷ 3", a: "17", trik: "B.2" },
          { q: "54 ÷ 3", a: "18", trik: "B.2" },
          { q: "57 ÷ 3", a: "19", trik: "B.2" },
          { q: "60 ÷ 3", a: "20", trik: "B.2" },
          { q: "63 ÷ 3", a: "21", trik: "B.2" },
          { q: "66 ÷ 3", a: "22", trik: "B.2" },
          { q: "69 ÷ 3", a: "23", trik: "B.2" },
          { q: "72 ÷ 3", a: "24", trik: "B.2" },
          { q: "75 ÷ 3", a: "25", trik: "B.2" },
          { q: "78 ÷ 3", a: "26", trik: "B.2" },
          { q: "81 ÷ 3", a: "27", trik: "B.2" },
          { q: "84 ÷ 3", a: "28", trik: "B.2" },
          { q: "87 ÷ 3", a: "29", trik: "B.2" },
          { q: "90 ÷ 3", a: "30", trik: "B.2" },
          { q: "93 ÷ 3", a: "31", trik: "B.2" },
          { q: "96 ÷ 3", a: "32", trik: "B.2" },
          { q: "99 ÷ 3", a: "33", trik: "B.2" },
        ],
        "C.2": [
          { q: "4 ÷ 4", a: "1", trik: "C.2" },
          { q: "8 ÷ 4", a: "2", trik: "C.2" },
          { q: "12 ÷ 4", a: "3", trik: "C.2" },
          { q: "16 ÷ 4", a: "4", trik: "C.2" },
          { q: "20 ÷ 4", a: "5", trik: "C.2" },
          { q: "24 ÷ 4", a: "6", trik: "C.2" },
          { q: "28 ÷ 4", a: "7", trik: "C.2" },
          { q: "32 ÷ 4", a: "8", trik: "C.2" },
          { q: "36 ÷ 4", a: "9", trik: "C.2" },
          { q: "40 ÷ 4", a: "10", trik: "C.2" },
          { q: "44 ÷ 4", a: "11", trik: "C.2" },
          { q: "48 ÷ 4", a: "12", trik: "C.2" },
          { q: "52 ÷ 4", a: "13", trik: "C.2" },
          { q: "56 ÷ 4", a: "14", trik: "C.2" },
          { q: "60 ÷ 4", a: "15", trik: "C.2" },
          { q: "64 ÷ 4", a: "16", trik: "C.2" },
          { q: "68 ÷ 4", a: "17", trik: "C.2" },
          { q: "72 ÷ 4", a: "18", trik: "C.2" },
          { q: "76 ÷ 4", a: "19", trik: "C.2" },
          { q: "80 ÷ 4", a: "20", trik: "C.2" },
          { q: "84 ÷ 4", a: "21", trik: "C.2" },
          { q: "88 ÷ 4", a: "22", trik: "C.2" },
          { q: "92 ÷ 4", a: "23", trik: "C.2" },
          { q: "96 ÷ 4", a: "24", trik: "C.2" },
          { q: "100 ÷ 4", a: "25", trik: "C.2" },
        ],
        "D.2": [
          { q: "6 ÷ 6", a: "1", trik: "D.2" },
          { q: "12 ÷ 6", a: "2", trik: "D.2" },
          { q: "18 ÷ 6", a: "3", trik: "D.2" },
          { q: "24 ÷ 6", a: "4", trik: "D.2" },
          { q: "30 ÷ 6", a: "5", trik: "D.2" },
          { q: "36 ÷ 6", a: "6", trik: "D.2" },
          { q: "42 ÷ 6", a: "7", trik: "D.2" },
          { q: "48 ÷ 6", a: "8", trik: "D.2" },
          { q: "54 ÷ 6", a: "9", trik: "D.2" },
          { q: "60 ÷ 6", a: "10", trik: "D.2" },
          { q: "66 ÷ 6", a: "11", trik: "D.2" },
          { q: "72 ÷ 6", a: "12", trik: "D.2" },
          { q: "78 ÷ 6", a: "13", trik: "D.2" },
          { q: "84 ÷ 6", a: "14", trik: "D.2" },
          { q: "90 ÷ 6", a: "15", trik: "D.2" },
          { q: "96 ÷ 6", a: "16", trik: "D.2" },
        ],
        "E.1": [
          { q: "7 ÷ 7", a: "1", trik: "E.1" },
          { q: "14 ÷ 7", a: "2", trik: "E.1" },
          { q: "21 ÷ 7", a: "3", trik: "E.1" },
          { q: "28 ÷ 7", a: "4", trik: "E.1" },
          { q: "35 ÷ 7", a: "5", trik: "E.1" },
          { q: "42 ÷ 7", a: "6", trik: "E.1" },
          { q: "49 ÷ 7", a: "7", trik: "E.1" },
          { q: "56 ÷ 7", a: "8", trik: "E.1" },
          { q: "63 ÷ 7", a: "9", trik: "E.1" },
          { q: "70 ÷ 7", a: "10", trik: "E.1" },
          { q: "77 ÷ 7", a: "11", trik: "E.1" },
          { q: "84 ÷ 7", a: "12", trik: "E.1" },
          { q: "91 ÷ 7", a: "13", trik: "E.1" },
          { q: "98 ÷ 7", a: "14", trik: "E.1" },
        ],
        "F.1": [
          { q: "8 ÷ 8", a: "1", trik: "F.1" },
          { q: "16 ÷ 8", a: "2", trik: "F.1" },
          { q: "24 ÷ 8", a: "3", trik: "F.1" },
          { q: "32 ÷ 8", a: "4", trik: "F.1" },
          { q: "40 ÷ 8", a: "5", trik: "F.1" },
          { q: "48 ÷ 8", a: "6", trik: "F.1" },
          { q: "56 ÷ 8", a: "7", trik: "F.1" },
          { q: "64 ÷ 8", a: "8", trik: "F.1" },
          { q: "72 ÷ 8", a: "9", trik: "F.1" },
          { q: "80 ÷ 8", a: "10", trik: "F.1" },
          { q: "88 ÷ 8", a: "11", trik: "F.1" },
          { q: "96 ÷ 8", a: "12", trik: "F.1" },
        ],
        "G.2": [
          { q: "9 ÷ 9", a: "1", trik: "G.2" },
          { q: "18 ÷ 9", a: "2", trik: "G.2" },
          { q: "27 ÷ 9", a: "3", trik: "G.2" },
          { q: "36 ÷ 9", a: "4", trik: "G.2" },
          { q: "45 ÷ 9", a: "5", trik: "G.2" },
          { q: "54 ÷ 9", a: "6", trik: "G.2" },
          { q: "63 ÷ 9", a: "7", trik: "G.2" },
          { q: "72 ÷ 9", a: "8", trik: "G.2" },
          { q: "81 ÷ 9", a: "9", trik: "G.2" },
          { q: "90 ÷ 9", a: "10", trik: "G.2" },
          { q: "99 ÷ 9", a: "11", trik: "G.2" },
        ],
        "H.1": [
          { q: "10 ÷ 10", a: "1", trik: "H.1" },
          { q: "20 ÷ 10", a: "2", trik: "H.1" },
          { q: "30 ÷ 10", a: "3", trik: "H.1" },
          { q: "40 ÷ 10", a: "4", trik: "H.1" },
          { q: "50 ÷ 10", a: "5", trik: "H.1" },
          { q: "60 ÷ 10", a: "6", trik: "H.1" },
          { q: "70 ÷ 10", a: "7", trik: "H.1" },
          { q: "80 ÷ 10", a: "8", trik: "H.1" },
          { q: "90 ÷ 10", a: "9", trik: "H.1" },
          { q: "100 ÷ 10", a: "10", trik: "H.1" },
        ],
        "H.2": [
          { q: "10 ÷ 5", a: "2", trik: "H.2" },
          { q: "20 ÷ 5", a: "4", trik: "H.2" },
          { q: "30 ÷ 5", a: "6", trik: "H.2" },
          { q: "40 ÷ 5", a: "8", trik: "H.2" },
          { q: "50 ÷ 5", a: "10", trik: "H.2" },
          { q: "60 ÷ 5", a: "12", trik: "H.2" },
          { q: "70 ÷ 5", a: "14", trik: "H.2" },
          { q: "80 ÷ 5", a: "16", trik: "H.2" },
          { q: "90 ÷ 5", a: "18", trik: "H.2" },
          { q: "100 ÷ 5", a: "20", trik: "H.2" },
        ],
        "H.3": [
          { q: "5 ÷ 5", a: "1", trik: "H.3" },
          { q: "15 ÷ 5", a: "3", trik: "H.3" },
          { q: "25 ÷ 5", a: "5", trik: "H.3" },
          { q: "35 ÷ 5", a: "7", trik: "H.3" },
          { q: "45 ÷ 5", a: "9", trik: "H.3" },
          { q: "55 ÷ 5", a: "11", trik: "H.3" },
          { q: "65 ÷ 5", a: "13", trik: "H.3" },
          { q: "75 ÷ 5", a: "15", trik: "H.3" },
          { q: "85 ÷ 5", a: "17", trik: "H.3" },
          { q: "95 ÷ 5", a: "19", trik: "H.3" },
        ],
      };

      // Updated levelsData with new categories and instruction IDs
      // Flattened structure for easier rendering and filtering
      const levelsData = [
        // Kategori: Fundamental Pembagian Cepat
        {
          id: "category_fundamental",
          type: "category",
          title: "Kategori: Fundamental Pembagian Cepat",
          instructionId: "fundamental_pembagian_cepat_instruksi",
        },
        {
          id: "level1",
          title: "Level 1: Pembagian dengan 2 (Dasar)",
          questions: allOriginalQuestions["A.1"],
          type: "question",
          categoryId: "category_fundamental",
        },
        {
          id: "level2",
          title: "Level 2: Pembagian dengan 2 (Puluhan Genap)",
          questions: allOriginalQuestions["A.2"],
          type: "question",
          categoryId: "category_fundamental",
        },
        {
          id: "level3",
          title: "Level 3: Pembagian dengan 2 (Puluhan Ganjil)",
          questions: allOriginalQuestions["A.3"],
          type: "question",
          categoryId: "category_fundamental",
        },
        {
          id: "level4",
          title: "Level 4: Pembagian Umum (Puluhan Genap)",
          questions: allOriginalQuestions["A.4.even"],
          type: "question",
          categoryId: "category_fundamental",
        },
        {
          id: "level5",
          title: "Level 5: Latihan Dasar Pembagian Umum (Puluhan Ganjil)",
          questions: allOriginalQuestions["A.4.odd.basic"],
          type: "question",
          categoryId: "category_fundamental",
        },
        {
          id: "level6_hafalan",
          title: "Hafalan: Trik Pembagian Umum (Puluhan Ganjil)",
          type: "hafalan",
          trikId: "A.4.odd",
          categoryId: "category_fundamental",
        },
        {
          id: "level7",
          title: "Level 7: Pembagian Umum (Puluhan Ganjil)",
          questions: allOriginalQuestions["A.4.odd.full"],
          type: "question",
          categoryId: "category_fundamental",
        },

        // Kategori: Pembagian dengan Trik Langsung
        {
          id: "category_trik_langsung",
          type: "category",
          title: "Kategori: Pembagian dengan Trik Langsung",
          instructionId: "trik_langsung_instruksi",
        },
        {
          id: "level8",
          title: "Level 8: Pembagian dengan 10",
          questions: allOriginalQuestions["H.1"],
          type: "question",
          categoryId: "category_trik_langsung",
        },
        {
          id: "level9",
          title: "Level 9: Pembagian dengan 5 (Akhiran 0)",
          questions: allOriginalQuestions["H.2"],
          type: "question",
          categoryId: "category_trik_langsung",
        },
        {
          id: "level10",
          title: "Level 10: Pembagian dengan 5 (Akhiran 5)",
          questions: allOriginalQuestions["H.3"],
          type: "question",
          categoryId: "category_trik_langsung",
        },
        {
          id: "level11",
          title: "Level 11: Pembagian dengan 9",
          questions: allOriginalQuestions["G.2"],
          type: "question",
          categoryId: "category_trik_langsung",
        },

        // Kategori: Pembagi Berulang & Memecah Bilangan
        {
          id: "category_pembagi_berulang",
          type: "category",
          title: "Kategori: Pembagi Berulang & Memecah Bilangan",
          instructionId: "pembagi_berulang_instruksi",
        },
        {
          id: "level12",
          title: "Level 12: Pembagian dengan 3",
          questions: allOriginalQuestions["B.2"],
          type: "question",
          categoryId: "category_pembagi_berulang",
        },
        {
          id: "level13",
          title: "Level 13: Pembagian dengan 4",
          questions: allOriginalQuestions["C.2"],
          type: "question",
          categoryId: "category_pembagi_berulang",
        },
        {
          id: "level14",
          title: "Level 14: Pembagian dengan 6",
          questions: allOriginalQuestions["D.2"],
          type: "question",
          categoryId: "category_pembagi_berulang",
        },
        {
          id: "level16",
          title: "Level 16: Pembagian dengan 8",
          questions: allOriginalQuestions["F.1"],
          type: "question",
          categoryId: "category_pembagi_berulang",
        },

        // Kategori: Kelipatan & Hafalan (Khusus Pembagi 7)
        {
          id: "category_kelipatan_hafalan",
          type: "category",
          title: "Kategori: Kelipatan & Hafalan (Khusus Pembagi 7)",
          instructionId: "kelipatan_hafalan_instruksi",
        },
        {
          id: "level15",
          title: "Level 15: Pembagian dengan 7",
          questions: allOriginalQuestions["E.1"],
          type: "question",
          categoryId: "category_kelipatan_hafalan",
        },

        // Kategori: Tes (No specific instruction modal, direct to test levels)
        { id: "category_test", type: "category", title: "Kategori: Tes" }, // No instructionId for test category
        {
          id: "level17_test",
          title: "Level 17: Tes Umum 1 (Acak)",
          questions: [],
          type: "test",
          categoryId: "category_test",
        },
      ];

      // Mapping trik ID ke deskripsi singkat (sesuai dokumen "Kumpulan Trik Cepat Pembagian")
      const trickDescriptions = {
        "A.1": "Dasar Genap Satu Digit: Langsung hafal hasilnya.",
        "A.2":
          "Kelipatan 10, Puluhan Genap: Bagi puluhan dengan 2, tambahkan 0.",
        "A.3":
          "Kelipatan 10, Puluhan Ganjil: Ambil angka genap di bawah puluhan, bagi 2, tambahkan 5.",
        "A.4.even":
          "Pembagian Umum (Puluhan Genap): Bagi puluhan dengan 2, bagi satuan dengan 2, lalu gabungkan hasilnya.",
        "A.4.odd":
          "Pembagian Umum (Puluhan Ganjil): Untuk bilangan puluhan ganjil, kurangi puluhan dengan 1 lalu bagi 2. Sisa 1 puluhan digabungkan dengan satuan (misal: 12, 14, 16, 18), lalu bagi 2. Gabungkan hasil dari kedua bagian.",
        "B.2":
          "Pembagian dengan 3: Bagi bilangan menjadi bagian yang mudah dibagi 3. (Contoh: 48 ÷ 3. Bagi 30 dengan 3 hasilnya 10. Sisa 18. Bagi 18 dengan 3 hasilnya 6. Jumlahkan 10 + 6 = 16.)",
        "C.2":
          "Pembagian dengan 4: Bagi bilangan dengan 2, lalu bagi hasilnya dengan 2 lagi. (Contoh: 48 ÷ 4. 48 ÷ 2 = 24. 24 ÷ 2 = 12. Hasilnya 12.)",
        "D.2":
          "Pembagian dengan 6: Bagi bilangan dengan 2, lalu bagi hasilnya dengan 3. (Contoh: 42 ÷ 6. 42 ÷ 2 = 21. 21 ÷ 3 = 7. Hasilnya 7.)",
        "E.1":
          "Pembagian dengan 7: Mengingat kelipatan 7. (Contoh: 56 ÷ 7. Ingat 7 × 8 = 56. Hasilnya 8. Untuk angka besar seperti 91 ÷ 7, bisa pecah: 70 ÷ 7 = 10, sisa 21 ÷ 7 = 3. Jadi 10 + 3 = 13.)",
        "F.1":
          "Pembagian dengan 8: Bagi bilangan dengan 2, lalu bagi hasilnya dengan 2 lagi, dan bagi lagi dengan 2. (Contoh: 48 ÷ 8. 48 ÷ 2 = 24. 24 ÷ 2 = 12. 12 ÷ 2 = 6. Hasilnya 6.)",
        "G.2":
          "Pembagian dengan 9: Ambil angka satuan dari bilangan yang dibagi, lalu kurangkan dari 10. Hasilnya adalah jawaban. (Contoh: 81 ÷ 9, ambil 1, 10 - 1 = 9. Hasilnya 9. Untuk 72 ÷ 9, ambil 2, 10 - 2 = 8. Hasilnya 8.)",
        "H.1": "Akhiran 0, Dibagi 10: Coret angka 0 di kedua bilangan.",
        "H.2":
          "Akhiran 0, Dibagi 5: Ambil angka puluhan, lalu kalikan dengan 2.", // Updated trick description
        "H.3": "Akhiran 5, Dibagi 5: Puluhan dikali 2, lalu tambah 1.",
      };

      // New object to store detailed instructions for each category
      const instructionDescriptions = {
        fundamental_pembagian_cepat_instruksi: {
          title: "Panduan: Fundamental Pembagian Cepat",
          content: `
                  Hai, teman-teman! Di kategori ini, kita akan belajar pembagian dengan <strong>2</strong>. Ini adalah dasar yang penting untuk trik-trik selanjutnya!
                  <br><br>
                  <h3>Trik Pembagian dengan 2 (Dasar):</h3>
                  Untuk angka kecil seperti 2, 4, 6, 8, kamu tinggal <strong>mengingat hasil baginya</strong> atau <strong>membagi dua</strong> saja.
                  <br>
                  Contoh: <strong>4 ÷ 2 = 2</strong> (Karena 2 + 2 = 4)
                  <br><br>
                  <h3>Trik Pembagian dengan 2 (Puluhan Genap):</h3>
                  Kalau ada angka puluhan genap yang diakhiri nol (seperti 20, 40, 60), cukup <strong>bagi angka puluhannya dengan 2, lalu tambahkan nol di belakangnya</strong>.
                  <br>
                  Contoh: <strong>40 ÷ 2</strong>
                  <br>
                  1. Ambil angka puluhannya: <strong>4</strong>
                  <br>
                  2. Bagi 4 dengan 2: <strong>4 ÷ 2 = 2</strong>
                  <br>
                  3. Tambahkan 0 di belakangnya: <strong>20</strong>
                  <br>
                  Jadi, <strong>40 ÷ 2 = 20</strong>
                  <br><br>
                  <h3>Trik Pembagian dengan 2 (Puluhan Ganjil):</h3>
                  Untuk angka puluhan ganjil yang diakhiri nol (seperti 10, 30, 50), triknya sedikit berbeda. Ambil angka genap di bawah puluhannya, bagi 2, lalu tambahkan 5.
                  <br>
                  Contoh: <strong>30 ÷ 2</strong>
                  <br>
                  1. Angka genap di bawah 30 adalah <strong>20</strong>. Bagi 20 dengan 2: <strong>20 ÷ 2 = 10</strong>
                  <br>
                  2. Tambahkan 5 ke hasilnya: <strong>10 + 5 = 15</strong>
                  <br>
                  Jadi, <strong>30 ÷ 2 = 15</strong>
                  <br><br>
                  <h3>Trik Pembagian Umum (Puluhan Genap):</h3>
                  Untuk angka dua digit genap (seperti 24, 46, 88), <strong>bagi dulu angka puluhannya dengan 2, lalu bagi angka satuannya dengan 2</strong>. Gabungkan hasilnya!
                  <br>
                  Contoh: <strong>46 ÷ 2</strong>
                  <br>
                  1. Bagi puluhannya: <strong>4 ÷ 2 = 2</strong>
                  <br>
                  2. Bagi satuannya: <strong>6 ÷ 2 = 3</strong>
                  <br>
                  3. Gabungkan: <strong>23</strong>
                  <br>
                  Jadi, <strong>46 ÷ 2 = 23</strong>
                  <br><br>
                  <h3>Trik Pembagian Umum (Puluhan Ganjil):</h3>
                  Ini trik yang perlu sedikit latihan! Untuk angka puluhan ganjil (seperti 32, 54, 78), <strong>kurangi puluhannya dengan 1, lalu bagi 2</strong>. Sisa 1 puluhan itu <strong>gabungkan dengan angka satuan</strong> (jadi 12, 14, 16, 18), lalu bagi 2. Gabungkan hasil dari kedua bagian.
                  <br>
                  Contoh: <strong>32 ÷ 2</strong>
                  <br>
                  1. Puluhan <strong>3</strong> dikurangi 1 menjadi <strong>2</strong>. Bagi 2 dengan 2: <strong>2 ÷ 2 = 1</strong>
                  <br>
                  2. Sisa 1 puluhan digabungkan dengan satuan 2 menjadi <strong>12</strong>. Bagi 12 dengan 2: <strong>12 ÷ 2 = 6</strong>
                  <br>
                  3. Gabungkan hasilnya: <strong>16</strong>
                  <br>
                  Jadi, <strong>32 ÷ 2 = 16</strong>
              `,
        },
        trik_langsung_instruksi: {
          title: "Panduan: Pembagian dengan Trik Langsung",
          content: `
                  Selamat datang di kategori trik langsung! Di sini, kita akan belajar cara cepat membagi dengan <strong>10, 5, dan 9</strong>. Triknya sangat mudah dan ada polanya!
                  <br><br>
                  <h3>Trik Pembagian dengan 10:</h3>
                  Jika bilangan yang dibagi dan pembaginya sama-sama punya angka nol di belakang, kamu tinggal <strong>coret saja angka nolnya</strong>!
                  <br>
                  Contoh: <strong>70 ÷ 10</strong>
                  <br>
                  1. Coret nol di 70 dan 10.
                  <br>
                  2. Tersisa <strong>7 ÷ 1 = 7</strong>
                  <br>
                  Jadi, <strong>70 ÷ 10 = 7</strong>
                  <br><br>
                  <h3>Trik Pembagian dengan 5 (Akhiran 0):</h3>
                  Untuk bilangan yang diakhiri nol dan dibagi 5, cukup <strong>ambil angka puluhannya, lalu kalikan dengan 2</strong>.
                  <br>
                  Contoh: <strong>40 ÷ 5</strong>
                  <br>
                  1. Ambil angka puluhannya: <strong>4</strong>
                  <br>
                  2. Kalikan 4 dengan 2: <strong>4 × 2 = 8</strong>
                  <br>
                  Jadi, <strong>40 ÷ 5 = 8</strong>
                  <br><br>
                  <h3>Trik Pembagian dengan 5 (Akhiran 5):</h3>
                  Untuk bilangan yang diakhiri angka 5 dan dibagi 5, <strong>ambil angka puluhannya, kalikan 2, lalu tambahkan 1</strong>.
                  <br>
                  Contoh: <strong>35 ÷ 5</strong>
                  <br>
                  1. Ambil angka puluhannya: <strong>3</strong>
                  <br>
                  2. Kalikan 3 dengan 2: <strong>3 × 2 = 6</strong>
                  <br>
                  3. Tambahkan 1: <strong>6 + 1 = 7</strong>
                  <<br>
                  Jadi, <strong>35 ÷ 5 = 7</strong>
                  <br><br>
                  <h3>Trik Pembagian dengan 9:</h3>
                  Ini trik sulap! Untuk bilangan yang bisa dibagi 9 (sampai 99), <strong>ambil angka satuan dari bilangan yang dibagi, lalu kurangkan dari 10</strong>. Hasilnya adalah jawabanmu!
                  <br>
                  Contoh: <strong>81 ÷ 9</strong>
                  <br>
                  1. Ambil angka satuan dari 81: <strong>1</strong>
                  <br>
                  2. Kurangkan dari 10: <strong>10 - 1 = 9</strong>
                  <br>
                  Jadi, <strong>81 ÷ 9 = 9</strong>
                  <br>
                  Contoh lain: <strong>72 ÷ 9</strong>
                  <br>
                  1. Ambil angka satuan dari 72: <strong>2</strong>
                  <br>
                  2. Kurangkan dari 10: <strong>10 - 2 = 8</strong>
                  <br>
                  Jadi, <strong>72 ÷ 9 = 8</strong>
              `,
        },
        pembagi_berulang_instruksi: {
          title: "Panduan: Pembagi Berulang & Memecah Bilangan",
          content: `
                  Di kategori ini, kita akan belajar trik pembagian yang menggunakan cara <strong>'memecah bilangan'</strong> atau <strong>'membagi berulang kali'</strong>. Ini sangat membantu untuk pembagi <strong>3, 4, 6, dan 8</strong>!
                  <br><br>
                  <h3>Trik Pembagian dengan 3:</h3>
                  Kita bisa <strong>memecah bilangan yang dibagi menjadi bagian yang lebih mudah dibagi 3</strong>. Gunakan kelipatan 10 dari 3 (seperti 30, 60, 90) sebagai 'jangkar' atau titik awal.
                  <br>
                  Contoh: <strong>48 ÷ 3</strong>
                  <br>
                  1. Pecah 48 menjadi <strong>30</strong> dan <strong>18</strong>.
                  <br>
                  2. Bagi 30 dengan 3: <strong>30 ÷ 3 = 10</strong>
                  <br>
                  3. Bagi sisa 18 dengan 3: <strong>18 ÷ 3 = 6</strong>
                  <br>
                  4. Jumlahkan hasilnya: <strong>10 + 6 = 16</strong>
                  <br>
                  Jadi, <strong>48 ÷ 3 = 16</strong>
                  <br><br>
                  <h3>Trik Pembagian dengan 4:</h3>
                  Ini mudah! Membagi dengan 4 itu sama dengan <strong>membagi dengan 2, lalu hasilnya dibagi 2 lagi</strong>.
                  <br>
                  Contoh: <strong>64 ÷ 4</strong>
                  <br>
                  1. Bagi 64 dengan 2: <strong>64 ÷ 2 = 32</strong>
                  <br>
                  2. Bagi 32 dengan 2 lagi: <strong>32 ÷ 2 = 16</strong>
                  <br>
                  Jadi, <strong>64 ÷ 4 = 16</strong>
                  <br><br>
                  <h3>Trik Pembagian dengan 6:</h3>
                  Karena 6 adalah 2 dikali 3, kita bisa <strong>membagi dengan 2 dulu, lalu hasilnya dibagi dengan 3</strong>.
                  <br>
                  Contoh: <strong>42 ÷ 6</strong>
                  <br>
                  1. Bagi 42 dengan 2: <strong>42 ÷ 2 = 21</strong>
                  <br>
                  2. Bagi 21 dengan 3: <strong>21 ÷ 3 = 7</strong>
                  <br>
                  Jadi, <strong>42 ÷ 6 = 7</strong>
                  <br><br>
                  <h3>Trik Pembagian dengan 8:</h3>
                  Ini mirip dengan pembagian 4, tapi kita <strong>membagi dengan 2 sebanyak tiga kali</strong>!
                  <br>
                  Contoh: <strong>72 ÷ 8</strong>
                  <br>
                  1. Bagi 72 dengan 2: <strong>72 ÷ 2 = 36</strong>
                  <br>
                  2. Bagi 36 dengan 2: <strong>36 ÷ 2 = 18</strong>
                  <br>
                  3. Bagi 18 dengan 2: <strong>18 ÷ 2 = 9</strong>
                  <br>
                  Jadi, <strong>72 ÷ 8 = 9</strong>
              `,
        },
        kelipatan_hafalan_instruksi: {
          title: "Panduan: Kelipatan & Hafalan (Khusus Pembagi 7)",
          content: `
                  Pembagian dengan <strong>7</strong> adalah yang paling unik, karena triknya lebih banyak mengandalkan <strong>hafalan dan pemahaman kelipatan</strong>. Jangan khawatir, kita bisa melakukannya!
                  <br><br>
                  <h3>Trik Pembagian dengan 7:</h3>
                  Cara terbaik adalah dengan <strong>mengingat dan menghafal kelipatan 7</strong>:
                  <br>
                  7, 14, 21, 28, 35, 42, 49, 56, 63, 70, 77, 84, 91, 98.
                  <br><br>
                  Coba ingat posisi angka yang dibagi dalam daftar kelipatan ini.
                  <br>
                  Contoh: <strong>56 ÷ 7</strong>
                  <br>
                  1. Ingat atau cari di daftar kelipatan: <strong>56</strong> adalah kelipatan ke-<strong>8</strong> dari 7 (karena 7 × 8 = 56).
                  <br>
                  Jadi, <strong>56 ÷ 7 = 8</strong>
                  <br><br>
                  Untuk angka yang lebih besar, kita bisa <strong>memecahnya menggunakan kelipatan 70 (7 x 10) sebagai 'jangkar'</strong>.
                  <br>
                  Contoh: <strong>91 ÷ 7</strong>
                  <br>
                  1. Kita tahu <strong>70 ÷ 7 = 10</strong> (ini adalah 'jangkar' kita).
                  <br>
                  2. Sisa dari 91 adalah <strong>91 - 70 = 21</strong>.
                  <br>
                  3. Sekarang, bagi sisa 21 dengan 7: <strong>21 ÷ 7 = 3</strong>.
                  <br>
                  4. Jumlahkan hasilnya: <strong>10 + 3 = 13</strong>
                  <br>
                  Jadi, <strong>91 ÷ 7 = 13</strong>
              `,
        },
      };

      let currentLevelId = null;
      let currentQuestions = [];
      let currentQuestionIndex = 0;
      let currentCategoryId = null; // To remember which category was selected for back navigation

      // Elemen-elemen DOM
      const mainSelectionScreen = document.getElementById(
        "main-selection-screen"
      ); // Main screen now combines category and level selection
      const gameScreen = document.getElementById("game-screen");
      const hafalanScreen = document.getElementById("hafalan-screen");
      const hafalanTitle = document.getElementById("hafalan-title");
      const hafalanTrickText = document.getElementById("hafalan-trick-text");
      const hafalanCompleteButton = document.getElementById(
        "hafalan-complete-button"
      );

      const categoryAndLevelListDiv = document.getElementById(
        "category-and-level-list"
      ); // Container for categories and levels
      const currentLevelTitle = document.getElementById("current-level-title");
      const flashCard = document.getElementById("flash-card");
      const questionText = document.getElementById("question-text");
      const answerText = document.getElementById("answer-text"); // For back of card
      const manualInput = document.getElementById("manual-input");
      const backArrowButton = document.getElementById("back-arrow-button"); // Back arrow button (for game/hafalan screen)
      const cardFeedbackMessageFront = document.getElementById(
        "card-feedback-message-front"
      ); // Feedback on front
      const cardFeedbackMessageBack = document.getElementById(
        "card-feedback-message-back"
      ); // Feedback on back
      const trickDescriptionDisplay = document.getElementById(
        "trick-description-display"
      );
      const currentTrickText = document.getElementById("current-trick-text");
      const testScoreDisplay = document.getElementById("test-score-display");
      const currentScoreSpan = document.getElementById("current-score");
      const totalTestQuestionsSpan = document.getElementById(
        "total-test-questions"
      );
      const progressBar = document.getElementById("progress-bar"); // Progress bar element
      const timerDisplay = document.getElementById("timer-display"); // Timer display element
      const overallProgressSummary = document.getElementById(
        "overall-progress-summary"
      ); // Overall progress summary element
      const levelProgressVisualizer = document.getElementById(
        "level-progress-visualizer"
      ); // New element for visualizer
      const level5InstructionHint = document.getElementById(
        "level5-instruction-hint"
      ); // New element for level 5 hint

      // Modal elements
      const instructionModal = document.getElementById("instruction-modal");
      const modalTitle = document.getElementById("modal-title");
      const modalInstructionText = document.getElementById(
        "modal-instruction-text"
      );
      const modalCloseButton = document.getElementById("modal-close-button");

      // Fungsi untuk menampilkan pesan feedback
      function showFeedback(message, type, side) {
        hideFeedback(); // Hide any existing feedback first
        let targetElement;
        if (side === "front") {
          targetElement = cardFeedbackMessageFront;
        } else if (side === "back") {
          targetElement = cardFeedbackMessageBack;
        }

        if (targetElement) {
          targetElement.textContent = message;
          targetElement.className = `card-feedback-message ${type}`; // Apply styling
          targetElement.style.display = "block"; // Make it visible
        }
      }

      // Fungsi untuk menyembunyikan pesan feedback (both front and back)
      function hideFeedback() {
        cardFeedbackMessageFront.textContent = "";
        cardFeedbackMessageFront.className = "card-feedback-message"; // Reset class
        cardFeedbackMessageFront.style.display = "none"; // Hide it

        cardFeedbackMessageBack.textContent = "";
        cardFeedbackMessageBack.className = "card-feedback-message"; // Reset class
        cardFeedbackMessageBack.style.display = "none"; // Hide it
      }

      // Fungsi untuk mengaktifkan/menonaktifkan input
      function setInputState(enabled) {
        manualInput.disabled = !enabled;
        if (enabled) {
          manualInput.focus();
        }
      }

      // Fungsi untuk mengacak array (Fisher-Yates shuffle)
      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }

      // Fungsi untuk memulai timer
      function startTimer() {
        stopTimer(); // Hentikan timer yang ada
        timeRemaining = questionTimeLimit;
        timerDisplay.textContent = `${timeRemaining}s`; // Tampilan awal

        timerInterval = setInterval(() => {
          timeRemaining--;
          timerDisplay.textContent = `${timeRemaining}s`;

          if (timeRemaining <= 0) {
            stopTimer();
            showFeedback("Waktu habis!", "feedback-incorrect", "front");
            manualInput.value = ""; // Kosongkan input
            setInputState(false); // Nonaktifkan input sementara

            setTimeout(() => {
              currentQuestionIndex++;
              displayQuestion();
            }, 1500); // Tunggu 1.5 detik sebelum pindah soal
          }
        }, 1000); // Perbarui setiap detik
      }

      // Fungsi untuk menghentikan timer
      function stopTimer() {
        clearInterval(timerInterval);
      }

      // Fungsi untuk memperbarui progress bar
      function updateProgressBar() {
        const progress = (currentQuestionIndex / currentQuestions.length) * 100;
        progressBar.style.width = `${progress}%`;
      }

      // Fungsi baru untuk memproses jawaban
      function processAnswer() {
        stopTimer(); // Hentikan timer saat jawaban disubmit
        const userAnswer = manualInput.value.trim();
        const correctAnswer = currentQuestions[currentQuestionIndex].a;

        if (userAnswer === correctAnswer) {
          showFeedback(`Benar!`, "feedback-correct", "back"); // Tampilkan di belakang kartu jika benar
          if (isTestLevel) {
            testScore++; // Tambah skor hanya untuk level tes
            currentScoreSpan.textContent = testScore; // Perbarui tampilan skor segera
          }
          flashCard.classList.add("flipped"); // Balik kartu otomatis
          manualInput.value = ""; // Kosongkan input segera
          setInputState(true); // Fokuskan kembali input

          // Timeout untuk melihat jawaban, lalu lanjut soal dan fokuskan input lagi
          setTimeout(() => {
            currentQuestionIndex++;
            displayQuestion();
          }, 1500); // Tunggu 1.5 detik sebelum pindah soal
        } else {
          showFeedback("Salah, coba lagi.", "feedback-incorrect", "front"); // Tampilkan di depan kartu jika salah
          manualInput.value = ""; // Kosongkan input untuk coba lagi
          setInputState(true); // Fokuskan kembali input
        }
      }

      // Fungsi untuk menampilkan soal saat ini
      function displayQuestion() {
        hideFeedback(); // Hide card feedback for new question
        manualInput.value = ""; // Bersihkan input
        flashCard.classList.remove("flipped"); // Pastikan kartu tidak terbalik
        setInputState(true); // Aktifkan input untuk soal baru dan fokuskan

        // Start timer only if it's not Level 5
        if (currentLevelId !== "level5") {
          startTimer();
          timerDisplay.classList.remove("hidden"); // Ensure timer is visible
        } else {
          stopTimer(); // Ensure timer is stopped for Level 5
          timerDisplay.classList.add("hidden"); // Hide timer for Level 5
        }

        updateProgressBar(); // Perbarui progress bar

        if (isTestLevel) {
          currentScoreSpan.textContent = testScore; // Update current score
        }

        if (currentQuestionIndex < currentQuestions.length) {
          const q = currentQuestions[currentQuestionIndex];
          questionText.textContent = q.q;
          answerText.textContent = q.a; // Set answer for back of card

          // Display the trick description above the card (only for non-test levels, or if test question has trik)
          if (
            q.trik &&
            trickDescriptions[q.trik] &&
            currentLevelId !== "level5"
          ) {
            // Hide trick for Level 5
            currentTrickText.textContent = trickDescriptions[q.trik];
            trickDescriptionDisplay.classList.remove("hidden");
          } else {
            trickDescriptionDisplay.classList.add("hidden"); // Hide if no trick or Level 5
          }
        } else {
          // Semua soal sudah selesai di level ini
          if (isTestLevel) {
            alert(
              `Tes Selesai! Skor Anda: ${testScore} dari ${totalTestQuestions}.`
            );
          } else {
            const completedLevelIndex = levelsData.findIndex(
              (lvl) => lvl.id === currentLevelId
            );
            // Only mark as completed if it's the next sequential level
            if (completedLevelIndex === highestCompletedLevel + 1) {
              highestCompletedLevel = completedLevelIndex;
              saveProgress(); // Save progress when a regular level is completed
            }
            if (currentLevelId === "level5") {
              alert(
                "Hebat! Kamu sudah melatih dasar-dasar trik ini. Sekarang saatnya memahami triknya lebih dalam di level Hafalan!"
              );
            } else {
              alert(
                "Selamat! Kamu telah menyelesaikan semua soal di level ini."
              );
            }
          }
          initApp(); // Kembali ke layar utama
        }
      }

      // Fungsi untuk menampilkan modal instruksi
      function showInstructionModal(instructionId) {
        const instruction = instructionDescriptions[instructionId];
        if (instruction) {
          modalTitle.textContent = instruction.title;
          modalInstructionText.innerHTML = instruction.content;
          instructionModal.classList.remove("hidden");
        }
      }

      // Fungsi untuk menyembunyikan modal instruksi
      function hideInstructionModal() {
        instructionModal.classList.add("hidden");
      }

      // Fungsi untuk menginisialisasi aplikasi dan menampilkan pilihan kategori/level utama
      async function initApp() {
        mainSelectionScreen.classList.remove("hidden");
        gameScreen.classList.add("hidden");
        hafalanScreen.classList.add("hidden");
        instructionModal.classList.add("hidden"); // Ensure modal is hidden

        categoryAndLevelListDiv.innerHTML = ""; // Clear category and level list
        hideFeedback();
        trickDescriptionDisplay.classList.add("hidden");
        testScoreDisplay.classList.add("hidden");
        stopTimer();
        level5InstructionHint.classList.add("hidden");

        await loadProgress();

        // Update overall progress summary
        const totalPlayableLevels = levelsData.filter(
          (item) => item.type === "question" || item.type === "hafalan"
        ).length;
        const completedPlayableLevels = levelsData
          .slice(0, highestCompletedLevel + 1)
          .filter(
            (item) => item.type === "question" || item.type === "hafalan"
          ).length;
        overallProgressSummary.textContent = `Level Selesai: ${completedPlayableLevels} dari ${totalPlayableLevels}`;

        // Render minimalist progress visualizer
        levelProgressVisualizer.innerHTML = "";
        let currentPlayableLevelCount = 0;
        for (let i = 0; i < levelsData.length; i++) {
          const item = levelsData[i];
          if (item.type === "question" || item.type === "hafalan") {
            const dot = document.createElement("div");
            dot.classList.add("w-4", "h-4", "rounded-full");
            if (i <= highestCompletedLevel) {
              dot.classList.add("bg-green-500");
            } else if (i === highestCompletedLevel + 1) {
              dot.classList.add("bg-blue-500", "ring-2", "ring-blue-300");
            } else {
              dot.classList.add("bg-gray-300");
            }
            levelProgressVisualizer.appendChild(dot);
            currentPlayableLevelCount++;
          }
        }

        let currentCategoryHeader = null;
        levelsData.forEach((item, index) => {
          if (item.type === "category") {
            // Create category header
            const categoryHeader = document.createElement("div");
            categoryHeader.classList.add(
              "col-span-full", // Make it span all columns
              "text-left",
              "text-2xl",
              "font-bold",
              "text-blue-700",
              "mt-6",
              "mb-2",
              "px-2",
              "cursor-pointer", // Indicate clickable
              "hover:text-blue-900" // Hover effect
            );
            categoryHeader.innerHTML = `${item.title} <span class="text-sm text-gray-500 font-normal">(Baca Petunjuk)</span>`; // Add hint

            // Attach click event to show modal
            if (item.instructionId) {
              categoryHeader.onclick = () =>
                showInstructionModal(item.instructionId);
            }
            categoryAndLevelListDiv.appendChild(categoryHeader);
            currentCategoryHeader = item.id; // Store current category ID for linking levels
          } else {
            // Create level button
            const button = document.createElement("button");
            button.textContent = item.title;
            button.className = "level-button";

            // Determine if the level is locked based on highestCompletedLevel
            const globalIndex = levelsData.findIndex(
              (lvl) => lvl.id === item.id
            );
            let isLocked = globalIndex > highestCompletedLevel + 1;

            button.disabled = isLocked;

            if (isLocked) {
              button.classList.add("locked");
              const lockIcon = document.createElement("i");
              lockIcon.classList.add("fas", "fa-lock");
              button.prepend(lockIcon);
              button.classList.add("bg-slate-300", "text-slate-600");
            } else {
              button.classList.remove("locked");
              button.classList.add(
                "bg-yellow-400",
                "hover:bg-yellow-500",
                "text-gray-800",
                "border-2",
                "border-yellow-500"
              );
            }

            button.onclick = () => {
              if (!isLocked) {
                currentCategoryId = item.categoryId; // Set the category ID for back navigation
                selectLevel(item.id);
              } else {
                console.log("Level ini masih terkunci!");
              }
            };
            categoryAndLevelListDiv.appendChild(button);
          }
        });
      }

      // Fungsi untuk memilih level dan memulai permainan (atau hafalan)
      function selectLevel(levelId) {
        const selectedLevel = levelsData.find((level) => level.id === levelId);
        if (!selectedLevel || selectedLevel.type === "category") return; // Should not happen for actual level selection

        currentLevelId = levelId; // Store the ID
        isTestLevel = selectedLevel.type === "test";

        mainSelectionScreen.classList.add("hidden"); // Hide main selection screen
        gameScreen.classList.add("hidden"); // Hide game screen by default
        hafalanScreen.classList.add("hidden"); // Hide hafalan screen by default
        instructionModal.classList.add("hidden"); // Ensure modal is hidden

        // Reset game screen elements visibility
        timerDisplay.classList.remove("hidden"); // Default to visible
        level5InstructionHint.classList.add("hidden"); // Default to hidden
        trickDescriptionDisplay.classList.remove("hidden"); // Default to visible
        manualInput.classList.remove("hidden"); // Default to visible
        flashCard.classList.remove("hidden"); // Default to visible

        if (selectedLevel.type === "hafalan") {
          // Handle hafalan level
          hafalanScreen.classList.remove("hidden"); // Show hafalan screen
          // currentScreen = "hafalan"; // No need for currentScreen state here, back button logic handles it

          hafalanTitle.textContent = selectedLevel.title;
          hafalanTrickText.textContent =
            trickDescriptions[selectedLevel.trikId];

          // Hide game-specific elements for hafalan screen
          timerDisplay.classList.add("hidden");
          progressBar.style.width = "0%"; // Reset progress bar
          testScoreDisplay.classList.add("hidden");
          trickDescriptionDisplay.classList.add("hidden"); // Hide game screen trick display
          manualInput.classList.add("hidden"); // Hide input
          flashCard.classList.add("hidden"); // Hide flash card
          level5InstructionHint.classList.add("hidden"); // Ensure hidden for hafalan

          // Set up the "Saya Sudah Hafal!" button
          hafalanCompleteButton.onclick = () => {
            const completedLevelIndex = levelsData.findIndex(
              (lvl) => lvl.id === currentLevelId
            );
            if (completedLevelIndex === highestCompletedLevel + 1) {
              highestCompletedLevel = completedLevelIndex; // Mark hafalan level as completed
              saveProgress(); // Save progress after completing hafalan level
            }
            initApp(); // Go back to main selection screen
          };
        } else if (selectedLevel.type === "question") {
          // Handle regular question level
          gameScreen.classList.remove("hidden");
          // currentScreen = "game"; // No need for currentScreen state here

          currentQuestions = [...selectedLevel.questions]; // Use questions from the selected level
          shuffleArray(currentQuestions);
          currentQuestionIndex = 0;

          currentLevelTitle.textContent = selectedLevel.title
            .split(":")[0]
            .trim();

          // Special handling for Level 5
          if (currentLevelId === "level5") {
            timerDisplay.classList.add("hidden"); // Hide timer for Level 5
            level5InstructionHint.classList.remove("hidden"); // Show hint for Level 5
            trickDescriptionDisplay.classList.add("hidden"); // Hide trick for Level 5
          } else {
            timerDisplay.classList.remove("hidden"); // Show timer for other levels
            level5InstructionHint.classList.add("hidden"); // Hide hint for other levels
            trickDescriptionDisplay.classList.remove("hidden"); // Show trick for other levels
          }

          displayQuestion();
        } else if (selectedLevel.type === "test") {
          // Handle test level
          gameScreen.classList.remove("hidden");
          // currentScreen = "game"; // No need for currentScreen state here (test is a type of game)

          let allQuestionsForTest = [];
          // Collect questions from ALL regular levels (excluding hafalan and test levels)
          levelsData.forEach((level) => {
            if (level.type === "question") {
              allQuestionsForTest = allQuestionsForTest.concat(
                level.questions.map((q) => ({ ...q, trik: q.trik }))
              );
            }
          });

          shuffleArray(allQuestionsForTest);
          currentQuestions = allQuestionsForTest.slice(0, totalTestQuestions);
          testScore = 0;
          totalTestQuestionsSpan.textContent = totalTestQuestions;
          testScoreDisplay.classList.remove("hidden");

          currentLevelTitle.textContent = selectedLevel.title
            .split(":")[0]
            .trim();
          timerDisplay.classList.remove("hidden"); // Ensure timer is visible
          level5InstructionHint.classList.add("hidden"); // Ensure hidden for test level
          trickDescriptionDisplay.classList.add("hidden"); // Hide trick for test level

          displayQuestion();
        }
      }

      // Firestore functions
      async function loadProgress() {
        if (!db) {
          console.warn(
            "Firestore not initialized. Progress will not be loaded."
          );
          return;
        }
        try {
          const progressDocRef = doc(
            db,
            `artifacts/${appId}/users/${userId}/game_progress/progress_doc`
          );
          const docSnap = await getDoc(progressDocRef);
          if (docSnap.exists()) {
            // Use the loaded value if it's higher than the default 0
            highestCompletedLevel = Math.max(
              highestCompletedLevel,
              docSnap.data().highestCompletedLevel || 0
            );
            console.log(
              "Loaded highest completed level:",
              highestCompletedLevel
            );
          } else {
            console.log("No progress found for user. Starting from level 0.");
            // highestCompletedLevel remains 0 as initialized
          }
        } catch (error) {
          console.error("Error loading progress:", error);
        }
      }

      async function saveProgress() {
        if (!db) {
          console.warn(
            "Firestore not initialized. Progress will not be saved."
          );
          return;
        }
        try {
          const progressDocRef = doc(
            db,
            `artifacts/${appId}/users/${userId}/game_progress/progress_doc`
          );
          await setDoc(
            progressDocRef,
            { highestCompletedLevel: highestCompletedLevel },
            { merge: true }
          );
          console.log("Progress saved:", highestCompletedLevel);
        } catch (error) {
          console.error("Error saving progress:", error);
        }
      }

      // Initialize Firebase
      async function initializeFirebase() {
        try {
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          // Authenticate user
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }

          // Listen for auth state changes to get userId
          onAuthStateChanged(auth, async (user) => {
            if (user) {
              userId = user.uid;
              console.log("User authenticated:", userId);
              initApp(); // Initialize app after loading progress
            } else {
              console.log("No user signed in. Using anonymous ID.");
              // Handle case where no user is signed in (e.g., anonymous sign-in failed)
              userId = crypto.randomUUID(); // Fallback to a random ID
              initApp(); // Initialize anyway, but progress won't persist if Firestore fails
            }
          });
        } catch (error) {
          console.error(
            "Error initializing Firebase or authenticating:",
            error
          );
          // Fallback if Firebase initialization fails
          userId = crypto.randomUUID(); // Use a random ID
          initApp(); // Initialize app even if Firebase fails
        }
      }

      // --- Event Listeners ---
      manualInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !manualInput.disabled) {
          processAnswer(); // Panggil fungsi prosesAnswer secara langsung
        }
      });

      // Back button on game/hafalan screen always goes to main selection
      backArrowButton.addEventListener("click", initApp);

      // Modal close button
      modalCloseButton.addEventListener("click", hideInstructionModal);

      // Close modal when clicking outside the content
      instructionModal.addEventListener("click", (event) => {
        if (event.target === instructionModal) {
          // Only close if clicking the backdrop itself
          hideInstructionModal();
        }
      });

      // Initialize Firebase and then the app
      initializeFirebase();
    </script>
  </body>
</html>
